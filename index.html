<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🦷DentBlog | 치의학 블로그</title>
  <meta name="description" content="치의학 영상·일반 학습을 위한 플래시카드 · 퀴즈 · 칼럼" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root{
      /* 라이트 모드 기본 */
      --bg:#fafafc;
      --panel:#ffffff; --panel-2:#f3f5f8; --text:#0f172a; --muted:#55627a; --line:#e4e8ef;
      --brand:#111827; --brand-2:#1f2937; --ok:#16a34a; --bad:#dc2626; --warn:#f59e0b;
      --radius:14px; --shadow:0 10px 30px rgba(15,23,42,.08); --maxw:1120px;
      
      /* 폰트 크기 정돈 및 모바일 최적화 */
      --fs-hero: clamp(24px, 2.4vw, 36px);
      --fs-h1: clamp(20px, 2vw, 28px);
      --fs-h2: clamp(17px, 1.6vw, 21px); 
      --fs-h3: clamp(16px, 1.5vw, 20px);
      --fs-body: clamp(14px, 1.2vw, 16px);
      --fs-small: clamp(12px, 1vw, 14px); 
      --fs-tiny: 11px; 
      /* 요청 2: 칼럼 사이드바 제목/레이블 폰트 크기 조정 */
      --fs-sidebar-title: 15px; 
      --fs-sidebar-list: 13px;
      --fs-sidebar-label: 12px;
      /* 요청 1: 만든 서비스 타이틀 폰트 크기 조정 */
      --fs-menu-title: 16px;
      --sidebar-width: 320px; 
    }
    /* 요청 3: 다크모드 색상 조정 */
    html.dark{
      --bg:#0f172a;
      --panel:#111827; 
      --panel-2:#1f2937; 
      --text:#e5e7eb; --muted:#94a3b8; --line:#374151;
      --brand:#e5e7eb; --brand-2:#cbd5e1; 
      --ok:#4ade80; --bad:#f87171; --warn:#facc15;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:500 var(--fs-body)/1.65 "Pretendard","Inter","Segoe UI",system-ui,-apple-system,sans-serif;
      background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      transition:background-color .25s, color .25s;
    }
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    button{cursor:pointer; font-family:inherit}
    
    /* UI 통일 */
    /* Quiz OX, 문항수 디자인 개선 반영 */
    .filter-group select,
    .filters input,
    #q, #blog-q,
    #quiz-mode, #quiz-n {
        font-size: var(--fs-small);
        padding: 10px 14px; 
        border-radius: 12px;
        border: 1px solid var(--line); 
        background: transparent; 
        color: var(--text);
        box-shadow: 0 1px 0 rgba(0,0,0,.04) inset;
        transition: border-color 0.15s;
    }
    .filters input:focus, #q:focus, #blog-q:focus {
        border-color: var(--brand);
        outline: none;
        background: var(--panel); 
    }
    .filter-group select,
    #quiz-mode, #quiz-n {
        appearance: none;
        -webkit-appearance: none;
        padding-right: 28px;
        background: var(--panel); 
    }
    .filters .label{font-weight:800; color:var(--muted); font-size:var(--fs-tiny);}

    /* Flashcard 타이머/지연 드롭다운 */
    .flash-frame .card label > select {
        padding: 8px 10px;
        border-radius: 8px;
        border: none; 
        background: var(--panel-2); 
        color: var(--text);
        font-size: var(--fs-small);
        appearance: none;
        -webkit-appearance: none;
        padding-right: 20px;
        min-width: 60px;
    }
    .flash-frame .card label.stat {
        border: 1px solid var(--line); 
        padding: 6px 10px;
        border-radius: 12px;
        background: var(--panel);
        font-weight: 500;
    }
    
    .btn.round {
        border: 1px solid var(--line); 
        box-shadow: 0 1px 0 rgba(0,0,0,.04) inset;
    }

    .set-tile .chip {
        font-size: var(--fs-tiny);
        padding: 2px 8px;
    }
    .stat{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--panel);border:1px solid var(--line); font-weight:800}
    .stat b { font-weight: 900; }
    
    header{position:sticky;top:0;z-index:50;background:color-mix(in oklab, var(--panel) 88%, transparent);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
    .nav{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900; letter-spacing:.1px; color:var(--brand)}
    .brand .logo{font-size:22px; line-height:1}
    .tabs{margin-left:auto;display:flex;gap:6px}
    .tab{padding:10px 14px;border-radius:10px;background:var(--panel); color:var(--muted); font-weight:700; box-shadow:0 1px 0 var(--line) inset; transition:all .15s}
    .tab.active{background:linear-gradient(180deg,#eef2ff,#e0e7ff); color:#111827; box-shadow: 0 1px 0 var(--line) inset;}
    html.dark .tab.active{background:var(--panel-2); color:var(--text); box-shadow: 0 1px 0 var(--line) inset;}

    .theme{margin-left:6px;border:none;border-radius:12px;padding:10px 12px;background:var(--panel); box-shadow:0 1px 0 var(--line) inset; color:var(--muted)}

    main{max-width:var(--maxw);margin:0 auto;padding:18px}
    section.view{display:none}
    section.view.active{display:block; min-height: calc(100vh - 120px); display: flex; flex-direction: column;}
    
    /* 요청 4: Footer에 넉넉한 공간 부여 */
    footer{
        margin: 48px 0 24px 0; 
        color:var(--muted); 
        text-align:center; 
        font-size: var(--fs-small); 
        margin-top: 60px; 
        padding-top: 10px; 
    }

    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px; transition:background-color .2s, border-color .2s}
    .shadow{box-shadow:var(--shadow)}
    .muted{color:var(--muted)}

    .btn{border:none;background:linear-gradient(180deg,#ffffff,#f8fafc);color:#0b1020;border-radius:12px;padding:10px 14px; font-weight:800; box-shadow:0 1px 0 rgba(0,0,0,.04) inset; transition:transform .08s ease;}
    .btn:active{transform:translateY(1px)}
    html.dark .btn{background:var(--panel); color:var(--text)}
    .btn.primary{background:linear-gradient(180deg,#222,#111); color:#fff}
    .btn.ok{background:linear-gradient(180deg,#34d399,#16a34a);color:#fff}
    .btn.bad{background:linear-gradient(180deg,#fca5a5,#ef4444);color:#fff}
    .btn.small{padding:8px 10px; border-radius:10px; font-weight:700}
    .btn.icon{border:none !important; background: transparent !important; color: var(--muted) !important; padding: 0;}
    
    .btn.toggle-icon {
        background: none;
        border: none;
        box-shadow: none;
        color: var(--muted);
        padding: 4px;
        width: 28px;
        height: 28px;
        display: grid;
        place-items: center;
        border-radius: 8px;
        transition: background 0.15s;
    }
    .btn.toggle-icon:hover {
        background: var(--panel-2);
        color: var(--text);
    }

    .btn-nav{border:none;background:var(--panel);color:var(--text);border-radius:12px;padding:10px 12px;display:inline-flex;align-items:center;gap:6px;font-weight:800;box-shadow:0 1px 0 var(--line) inset;transition:transform .08s}
    .btn-nav:active{transform:translateY(1px)}

    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#eef2ff;color:#1e3a8a;}
    html.dark .chip{background:var(--panel-2); color:var(--text)}
    .grid{display:grid;gap:12px}
    .hero{display:grid;gap:8px;margin:6px 0 14px;text-align:center;padding: 16px 0;}
    .hero h1{margin:0;font-size:var(--fs-hero); font-weight:900}
    .hero p{margin:0 auto; max-width:780px; font-size: clamp(15px, 1.3vw, 18px)}

    /* 요청 1: 통계 간격 현재의 절반으로 줄이기 (22px -> 11px) */
    .hero-stats-container {
      margin-top: 11px; 
    }

    .typing{
        display: inline-block;
        overflow: hidden;
        white-space: nowrap;
        border-right: 2px solid var(--brand);
        animation: typing 4s steps(40,end) 1, caret 1s step-end infinite;
    }
    @keyframes typing{ from{width:0} to{width:100%} }
    @keyframes caret{ 50%{border-color:transparent} }

    .set-tile{display:flex;gap:14px; cursor:pointer; padding:12px; border:1px solid var(--line); border-radius:12px; background:var(--panel)}
    .set-tile:hover{background:var(--panel-2)}
    
    .tile-body{flex:1;display:grid;gap:6px}

    .progress{height:10px;background:#e5e7eb;border:1px solid #d1d5db;border-radius:999px;overflow:hidden}
    html.dark .progress{background:var(--panel-2);border-color:var(--line)}
    .progress>i{display:block;height:100%;background:#111827}

    /* Flashcard 레이아웃 */
    .flash-frame{
        display: flex; 
        flex-direction: column;
        box-shadow:var(--shadow);
    }
    /* 사진, 문제, 정답 영역 */
    .flash-content-area { 
        order: 1; 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 16px; 
    }
    /* 채점, 타이머 영역 */
    .flash-controls-container {
        order: 2; 
        grid-column: 1 / -1; 
        margin-top: 16px; 
        padding-top: 0;
        padding-bottom: 0;
        display: flex;
        flex-direction: column; 
        gap: 16px;
    }
    .flash-controls-container .card {
        padding: 14px; 
    }
    .flash-score-area { 
        order: 1;
    }
    .flash-timer-area { 
        order: 2;
    }

    @media (max-width:900px){ 
        .flash-content-area{ grid-template-columns:1fr } 
    }
    @media (min-width: 901px) {
        .flash-controls-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .flash-score-area, .flash-timer-area {
            order: initial;
            gap: 16px;
            padding: 0;
        }
    }


    .flash-visual{display:flex; justify-content:center; align-items:center; padding:16px}
    .flash-visual img{max-height:420px; width:100%; height:auto; object-fit:contain}

    .flash-card{position:relative; padding:12px; cursor:pointer; display: flex; flex-direction: column; justify-content: center; align-items: center;}
    
    /* 카드 UI */
    .flash-card .front{
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 20px 16px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: var(--panel);
        text-align: center;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.5;
        width: 100%;
        min-height: 160px;
    }
    /* 요청 2: 문제 폰트 크기/두께 조정 */
    #flash-question {
      font-size: var(--fs-h1); 
      font-weight: 500; 
      transition: all 0.2s ease;
    }
    .flash-card.show-back #flash-question {
        font-size: var(--fs-body);
        font-weight: 500;
        color: var(--muted);
    }
    
    .flash-card .back {
        display: none; 
        background: var(--panel-2); 
        padding: 12px;
        border-radius: 10px;
        margin-top: 24px; 
        border: 1px solid var(--line);
        width: 100%;
    }
    .flash-card.show-back .back { display: block; }
    
    #flash-answer {
      font-size: var(--fs-h2);
      font-weight: 900;
    }
    #flash-explain {
      font-size: var(--fs-small);
    }

    .countdown{position:absolute; inset:0; display:grid; place-items:center;background:rgba(0,0,0,.55); color:#fff; font-size:48px; font-weight:900;border-radius:12px; opacity:0; transition:opacity .2s;pointer-events:none; z-index:2;}
    .countdown.show{ opacity:1; pointer-events:auto }

    .bin{ text-align:center }
    .bin-bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;}
    .bin-bar i{height:100%;display:block;background:#111827; transition:width .2s ease-in-out;}

    .opt{border:1px solid var(--line);border-radius:10px;padding:12px;background:var(--panel); transition:all .2s; font-size: var(--fs-body);}
    .opt:hover{border-color:#111827;background:var(--panel-2)}
    .opt.correct{border-color:var(--ok);background:color-mix(in oklab, var(--ok) 18%, transparent)}
    .opt.wrong{border-color:var(--bad);background:color-mix(in oklab, var(--bad) 18%, transparent)}

    /* 홈 탭 레이아웃 조정 */
    .home-grid-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px; 
        margin-bottom: 24px;
    }
    .home-grid-container > .card {
        margin-top: 0; 
    }
    /* 요청 1: 칼럼 제목 크기 키우기 */
    #home-blog-list .card > div:first-child {
        font-size: var(--fs-body) !important; 
    }


    @media (min-width: 768px) {
        #home-reco {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)) !important;
        }
    }
    @media (min-width: 1024px) {
        /* 넓은 화면에서 추천 세트는 가로로 2개 이하 (최대 2개) */
        #home-reco {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    
    /* Quiz 모드/문항수 필터 스타일 조정 */
    .quiz-controls-group {
        display: flex; 
        gap: 8px; 
        flex-wrap: wrap; 
        align-items: center;
    }
    .quiz-controls-group label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 700;
        color: var(--muted);
        font-size: var(--fs-small);
    }

    /* 칼럼 탭 레이아웃 및 폰트 크기 조정 */
    .blog-container {
        display: grid;
        grid-template-columns: var(--sidebar-width) 1fr;
        gap: 16px;
    }
    .blog-main-content {
        transition: transform 0.3s ease-out, width 0.3s ease-out, margin-left 0.3s ease-out;
    }
    .blog-sidebar{
        position:sticky; top:84px; align-self:flex-start; max-height:calc(100vh - 120px); overflow-y:auto; padding:0; transition: all 0.3s ease-out;
        width: var(--sidebar-width);
    } 
    .blog-sidebar.collapsed {
        width: 0;
        opacity: 0;
        padding: 0;
        margin-right: -16px; 
    }
    @media (min-width: 981px) {
        .blog-sidebar.collapsed + .blog-main-content {
            transform: translateX(calc( -1 * var(--sidebar-width) - 16px)); 
            width: calc(100% + var(--sidebar-width) + 16px);
            margin-left: 0;
        }
    }
    @media (max-width: 980px) {
        .blog-container {
            grid-template-columns: 1fr;
        }
        .blog-sidebar {
            width: 100%;
        }
        .blog-sidebar.collapsed {
            width: 100%; 
            height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .blog-sidebar.collapsed + .blog-main-content {
             transform: translateX(0); 
             width: 100%;
             margin-left: 0;
        }
        .blog-header-controls {
            flex-wrap: nowrap !important;
        }
    }
    
    /* 요청 2: 칼럼 사이드바 제목/레이블/목록 폰트 스타일 및 간격 조정 */
    .blog-sidebar .card > div > div:first-child {
        font-weight: 700; /* 두께감 줄임 (900 -> 700) */
        font-size:var(--fs-sidebar-title); 
    }
    /* 요청 2: 섹션 간 간격 50% 늘리기 (16px -> 24px) */
    .blog-sidebar .card > div:not(.filters) {
        padding-top: 24px;
    }
    .blog-sidebar .card > div:first-child {
        padding-top: 0;
    }

    .blog-sidebar .filters .label {
        font-size: var(--fs-sidebar-label); 
    }
    .blog-list a{
        padding:8px 10px;
        font-size: var(--fs-sidebar-list); 
    }
    .toc{
        font-size: var(--fs-sidebar-list); 
    }

    .blog-sidebar .card > div {
        padding: 12px 0 8px 0;
    }
    .blog-sidebar .card > div.filters {
        padding: 12px 0 12px 0;
    }
    .blog-sidebar .card .blog-list,
    .blog-sidebar .card .toc {
        margin-top: 0;
    }
    .blog-list { list-style: none; }
    .blog-list a{display:block;color:var(--muted);border:1px solid transparent;}
    .blog-list a:hover{background:var(--panel-2); color:var(--text)}
    
    .blog-list a.active{background:#111827; color:#fff; font-weight:800; border-color:transparent}
    .blog-view{padding:18px;min-height:160px; background:var(--panel); border-radius:12px; box-shadow:var(--shadow)}
    .blog-view h1{font-size:var(--fs-h1);margin:.2em 0 .5em; border-bottom:1px solid var(--line); padding-bottom:8px}
    .blog-view h2{font-size:var(--fs-h2);margin:1.3em 0 .4em; border-bottom:none; padding-bottom:0}
    .blog-view h3{font-size:var(--fs-h3);margin:1em 0 .4em}
    
    .toc ul{list-style:none;margin:0;padding-left:0}
    .toc li{margin:6px 0 0 0;padding-left:12px;border-left:1px dashed var(--line)}
    .toc a{color:var(--muted)}
    .toc a:hover{color:var(--text)}
    
    .blog-header-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }
    .blog-header-controls input#blog-q {
        flex-grow: 1;
        min-width: 150px;
    }
    
    .sets .hero {
        padding-bottom: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .sets .hero h1 {
        margin: 0;
    }
    .sets-search-bar {
        margin-left: auto;
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .sets-search-bar input#q {
        width: 200px;
    }
    
    /* 세트 필터 레이아웃 조정 */
    .sets .filters {
        display: grid !important; 
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 16px 8px; 
    }
    .sets .filters .filter-group:nth-child(1),
    .sets .filters .filter-group:nth-child(2) {
        grid-row: 1;
    }
    .sets .filters .filter-group:nth-child(3) {
        grid-column: 1 / -1; 
        grid-row: 2;
    }
    
    /* 요청 1: 만든 서비스 타이틀 폰트 크기 조정 */
    .side-menu h3 {
        font-size: var(--fs-menu-title); 
    }

    /* 만든 서비스 슬라이드 메뉴 스타일 */
    .side-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        max-width: 90vw;
        height: 100%;
        background: var(--panel);
        border-right: 1px solid var(--line);
        box-shadow: 0 0 30px rgba(0,0,0,.15);
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-out, opacity 0.3s, visibility 0.3s;
        padding: 20px;
        box-sizing: border-box;
        visibility: hidden; 
        opacity: 0; 
    }
    .side-menu.open {
        transform: translateX(0);
        visibility: visible;
        opacity: 1;
    }
    .side-menu h3 {
        color: var(--muted);
        font-weight: 900;
        letter-spacing: 0.5px;
        margin-top: 0;
    }
    .side-menu ul {
        list-style: none;
        padding: 0;
        margin-top: 16px;
    }
    .side-menu li a {
        display: block;
        padding: 12px;
        margin: 4px 0;
        border-radius: 8px;
        font-weight: 700;
        color: var(--text);
        transition: background 0.1s;
    }
    .side-menu li a:hover {
        background: var(--panel-2);
    }
    /* 오버레이 스타일 */
    .menu-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .menu-overlay.open {
        opacity: 1;
        visibility: visible;
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <button id="menu-toggle-btn" class="theme" data-action="toggle-menu" aria-label="메뉴 열기" style="margin-left: 0; margin-right: 8px;">☰</button>
      <div class="brand" data-nav="home" role="button" aria-label="홈으로 이동">
        <div class="logo">🦷</div><div>DentBlog</div>
      </div>
      <div class="tabs" role="tablist">
        <a class="tab" data-nav="home" role="tab" aria-selected="true">🏠</a>
        <a class="tab" data-nav="sets" role="tab">♠️</a>
        <a class="tab" data-nav="blog" role="tab">✏️</a>
      </div>
      <button id="theme-btn" class="theme" data-action="toggle-theme" aria-label="테마 전환">🌠</button>
    </div>
  </header>
  
  <!-- 사이드 메뉴 -->
  <div id="side-menu" class="side-menu">
      <h3 style="margin-top: 0; border-bottom: 1px solid var(--line); padding-bottom: 8px;">만든 서비스</h3>
      <ul>
          <li><a href="https://url.kr/p/charmap/" target="_blank">❤️문자표</a></li>
          <li><a href="https://ocs-excel-tool.onrender.com/" target="_blank">🧡엑셀 변환</a></li>
          <li><a href="https://ocs-excel-tool.onrender.com/doni/ocs/0920" target="_blank">💜도니 툴</a></li>
      </ul>
  </div>
  <div id="menu-overlay" class="menu-overlay" data-action="toggle-menu"></div>
  <!-- /사이드 메뉴 -->

  <main>
    <section id="view-home" class="view active home">
      <div class="hero">
        <h1>치의학 블로그</h1>
        <p class="typing">플래시카드·퀴즈·칼럼으로 치의학을 쉽게 학습하세요.</p>
        <!-- 요청 1: 통계 간격 현재의 절반으로 줄이기 (CSS hero-stats-container margin-top 조정) -->
        <div id="home-stats" class="chips hero-stats-container" style="justify-content:center; gap:8px"></div>
      </div>

      <div class="card shadow" style="padding:0; overflow:hidden; margin-bottom:12px">
        <div style="display:flex; overflow:auto; gap:12px; padding:12px;">
          <img src="https://via.placeholder.com/1100x120/222222/ffffff?text=BANNER+1" alt="배너" style="width:100%; min-width:320px; height:120px; object-fit:cover; border-radius:8px;"/>
        </div>
      </div>

      <div class="home-grid-container">
        <div class="card shadow">
          <div class="muted" style="font-weight:800;margin-bottom:8px">추천 세트</div>
          <div id="home-reco" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(320px,1fr));"></div>
        </div>
        <div class="card shadow">
          <div class="muted" style="font-weight:800;margin-bottom:8px">칼럼 최신</div>
          <!-- 요청 1: 칼럼 제목 크기를 키우기 위해 CSS #home-blog-list .card > div:first-child 스타일 적용됨 -->
          <div id="home-blog-list" class="grid" style="grid-template-columns:1fr; gap:8px;"></div>
        </div>
      </div>

      <!-- 요청 4, 5: 넉넉한 공간을 가진 footer (그 아래 아무것도 없음) -->
      <footer><a href="https://dashing-leek-81d.notion.site/27b4376fbca680d2b09af2c3fea276d6?source=copy_link" target="_blank">© 2025 DentBlog · made by DO</a></footer>
    </section>

    <section id="view-sets" class="view sets">
      <div class="hero" style="text-align:left">
        <h1 style="font-size:var(--fs-h1)">학습 세트</h1>
        <div class="sets-search-bar">
            <input id="q" placeholder="세트 검색"/>
        </div>
      </div>
      <div class="card shadow" style="margin-bottom:12px">
        <!-- 필터 그룹들 -->
        <div class="filters">
            <div class="filter-group">
                <label for="group" class="label">과목</label>
                <select id="group">
                    <option value="">전체</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="mod" class="label">분류</label>
                <select id="mod">
                    <option value="">전체</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="tags" class="label">태그</label>
                <div id="tag-filter-list" class="chips"></div>
            </div>
        </div>
      </div>
      <div id="set-list" class="grid" style="grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));"></div>
      
      <!-- 요청 4, 5: 넉넉한 공간을 가진 footer (그 아래 아무것도 없음) -->
      <footer><a href="https://dashing-leek-81d.notion.site/27b4376fbca680d2b09af2c3fea276d6?source=copy_link" target="_blank">© 2025 DentBlog · made by DO</a></footer>
    </section>

    <section id="view-flash" class="view">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
        <h2 id="flash-title" style="margin:0; font-size:var(--fs-h1)"></h2>
        <div style="display:flex;gap:8px;">
          <button class="btn-nav" data-action="flash-prev">←</button>
          <button class="btn-nav" data-action="flash-next">→</button>
        </div>
      </div>

      <div class="progress"><i id="flash-bar" style="width:0%"></i></div>

      <!-- Flash에서 사진, 문제, 정답은 채점 공간 "위로" 올리기 (order: 1) -->
      <div id="flash-frame" class="card shadow flash-frame" style="margin-top:12px">
        
        <!-- 콘텐츠 영역 (문제/이미지) -->
        <div class="flash-content-area">
            <div class="flash-visual">
              <img id="flash-img" alt="x-ray"/>
            </div>

            <div class="flash-card" id="flash-card" data-action="flash-toggle">
              <div class="front" id="flash-front">
                <div style="display:flex; flex-direction: column; align-items:center; justify-content:center; text-align:center; width: 100%;">
                  <span id="flash-question">이 영상의 진단명은?</span>
                  <div class="back" id="flash-back">
                      <!-- 요청 3: Footer 아래 불필요한 메시지 제거 -->
                      <div class="muted" style="margin-bottom: 4px; font-size: var(--fs-small);">정답</div>
                      <div id="flash-answer" style="margin:4px 0 8px"></div>
                      <div id="flash-explain" class="muted" style="max-width:520px;margin:0 auto;"></div>
                  </div>
                </div>
              </div>
              <div id="countdown" class="countdown" aria-hidden="true"></div>
            </div>
        </div>
            
        <!-- 채점 공간과 타이머 공간 (order: 2) -->
        <div class="flash-controls-container">
            <!-- 채점 공간 -->
            <div class="card flash-score-area">
                <div class="muted" style="font-weight:800;margin-bottom:8px">채점</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn ok"  data-action="flash-grade" data-ok="1">알았다</button>
                    <button class="btn bad" data-action="flash-grade" data-ok="0">몰랐다</button>
                </div>
                <div id="bins" style="display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-top: 12px;"></div>
            </div>

            <!-- 타이머 공간 (채점 공간 아래에 위치) -->
            <div class="card flash-timer-area">
                <div class="muted" style="font-weight:800;margin-bottom:8px">타이머</div>
                <div style="display:flex;gap:10px;align-items:center; flex-wrap:wrap">
                    <span id="flash-pos" class="stat">0/0</span>
                    <label class="stat" style="display:flex; align-items:center; gap: 4px;">
                        <span style="font-weight: 800;">타이머</span>
                        <select id="timer-select">
                            <option value="3">3초</option>
                            <option value="5" selected>5초</option>
                            <option value="10">10초</option>
                        </select>
                    </label>
                    <label style="display:inline-flex;gap:6px;align-items:center;margin-left:8px; font-size: var(--fs-small);">
                        <input type="checkbox" id="auto-next" checked />
                        자동 넘김
                    </label>
                    <label class="stat" style="display:flex; align-items:center; gap: 4px;">
                        <span style="font-weight: 800;">지연</span>
                        <select id="auto-next-delay">
                            <option value="3000">3초</option>
                            <option value="5000" selected>5초</option>
                            <option value="7000">7초</option>
                            <option value="10000">10초</option>
                        </select>
                    </label>
                    <button class="btn round" data-action="flash-autoplay" id="autoplay-btn" aria-label="연속 자동 학습 토글">▶</button>
                </div>
            </div>
        </div>
      </div>
      
      <!-- 요청 4, 5: 넉넉한 공간을 가진 footer (그 아래 아무것도 없음) -->
      <footer><a href="https://dashing-leek-81d.notion.site/27b4376fbca680d2b09af2c3fea276d6?source=copy_link" target="_blank">© 2025 DentBlog · made by DO</a></footer>
    </section>

    <section id="view-quiz" class="view">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h2 id="quiz-title" style="margin:0; font-size:var(--fs-h1)"></h2>
      </div>
      
      <!-- 시작 전 컨트롤 그룹 -->
      <div class="card shadow" id="quiz-controls" style="margin-bottom:10px">
        <div class="quiz-controls-group">
          <label>모드
            <select id="quiz-mode">
              <option value="tf">OX</option>
              <option value="fill">빈칸</option>
            </select>
          </label>
          <label>문항 수
            <select id="quiz-n">
              <option>5</option><option selected>10</option><option>15</option>
            </select>
          </label>
          <button class="btn primary" data-action="quiz-start">시작</button>
        </div>
      </div>
      
      <div class="card shadow" id="quiz-stage" style="display:none"></div>
      
      <!-- 요청 4, 5: 넉넉한 공간을 가진 footer (그 아래 아무것도 없음) -->
      <footer><a href="https://dashing-leek-81d.notion.site/27b4376fbca680d2b09af2c3fea276d6?source=copy_link" target="_blank">© 2025 DentBlog · made by DO</a></footer>
    </section>

    <section id="view-blog" class="view">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h1 style="margin:0;font-size:var(--fs-h1)">칼럼</h1>
        <button class="btn toggle-icon" data-action="blog-sidebar-toggle" id="blog-sidebar-toggle-btn" aria-label="사이드바 토글">▾</button>
        
        <div class="blog-header-controls" style="margin-left:auto;">
            <input id="blog-q" placeholder="칼럼 검색"/>
        </div>
      </div>

      <div class="blog-container">
        <aside id="blog-sidebar" class="blog-sidebar">
          <div class="card" style="padding:12px; position:sticky; top:84px; align-self:flex-start; max-height:calc(100vh - 120px); overflow-y:auto;">
            
            <!-- 정렬 및 태그 섹션 -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px; padding-bottom:8px;">
              <div>정렬 및 태그</div>
              <button class="btn toggle-icon" data-action="blog-filters-toggle" id="blog-filters-toggle-btn" title="접기/펼치기">▴</button>
            </div>
            <div id="blog-filters" class="filters" style="margin-top:4px; margin-bottom: 24px; display: block; gap: 12px;">
                <div class="filter-group" style="margin-bottom: 12px;">
                    <label for="blog-sort" class="label">정렬</label>
                    <select id="blog-sort">
                        <option value="desc">최신순</option>
                        <option value="asc">오래된순</option>
                    </select>
                </div>
                <div class="filter-group" style="display: block;">
                    <label class="label">태그</label>
                    <div id="category-filter-list" class="chips" style="margin-top: 6px;"></div>
                </div>
            </div>
            
            <!-- 글 목록 섹션 -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px; padding-top:4px; padding-bottom:8px;">
              <div>글 목록</div>
              <button class="btn toggle-icon" data-action="blog-list-toggle" id="blog-list-toggle-btn" title="접기/펼치기">▴</button>
            </div>
            <ul id="blog-list" class="blog-list" style="margin-top:4px; margin-bottom: 24px;"></ul>
            
            <!-- 목차 섹션 -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px; padding-top:4px; padding-bottom:8px;">
              <div>목차</div>
              <button class="btn toggle-icon" data-action="blog-toc-toggle" id="blog-toc-toggle-btn" title="접기/펼치기">▴</button>
            </div>
            <div id="blog-toc" class="toc" style="display:none; margin-top: 4px;"></div>

          </div>
        </aside>
        
        <div class="blog-main-content" style="overflow: hidden;">
            <div id="blog-view" class="blog-view"></div>
            
            <div id="blog-nav-buttons" style="display:flex; justify-content:space-between; gap: 8px; margin-top: 12px; border-top: 1px solid var(--line); padding-top: 12px;">
              <button class="btn-nav" data-action="blog-prev" id="blog-prev-btn" style="visibility: hidden;">← </button>
              <button class="btn-nav" data-action="blog-next" id="blog-next-btn" style="visibility: hidden;"> →</button>
            </div>
            
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
              <button class="btn round" data-action="tts-body" aria-label="본문 읽기/일시정지" style="width:36px;height:36px;padding:0;display:grid;place-items:center;">▶</button>
              <button class="btn round" data-action="tts-stop" aria-label="정지" style="width:36px;height:36px;padding:0;display:grid;place-items:center;">■</button>
            </div>
        </div>
      </div>
      
      <!-- 요청 4, 5: 넉넉한 공간을 가진 footer (그 아래 아무것도 없음) -->
      <footer><a href="https://dashing-leek-81d.notion.site/27b4376fbca680d2b09af2c3fea276d6?source=copy_link" target="_blank">© 2025 DentBlog · made by DO</a></footer>
    </section>

    <section id="view-admin" class="view">
      <!-- 요청 4, 5: 넉넉한 공간을 가진 footer (그 아래 아무것도 없음) -->
      <footer><a href="https://dashing-leek-81d.notion.site/27b4376fbca680d2b09af2c3fea276d6?source=copy_link" target="_blank">© 2025 DentBlog · made by DO</a></footer>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loader" aria-hidden="true"><div class="spinner" aria-label="로딩중"></div></div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ====== 기본 설정 ======
    const baseUrl = 'https://raw.githubusercontent.com/nihicheli/dentblog/main/';
    const ADMIN_KEY='0917';
    const VISIBLE_CATEGORIES_LIMIT = 6;

    // ====== 유틸 ======
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const $  = (sel,root=document)=>root.querySelector(sel);
    // 요청 5: "정답 공개!" 등의 메시지는 모두 삭제 (note 함수 내 로직 변경)
    const logDev=(...args)=>{ /* console.log('[DEV]', ...args); */ }; 
    const note=(msg, warn)=>{ 
      if(msg.includes('정답 공개!') || msg.includes('✓ 알았다') || msg.includes('× 몰랐다') || msg.includes('정답')) return;
      const t=$('#toast'); if(!t) return; t.textContent=msg; t.style.background= warn? '#991b1b':'#111827'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400); 
    };
    const busy=(on,msg)=>{ /* 로딩 메시지 숨김 */ const l=$('#loader'); if(!l) return; if(on){ l.classList.add('show'); } else { l.classList.remove('show'); } }; 
    const uid=()=>Math.random().toString(36).slice(2,9);
    const slug=s=>(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+uid());
    const esc=s=>(s==null?'':String(s)).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const mdDate=t=>{ const d=new Date(t); const mm=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return `${mm}/${dd}` };
    const norm=s=>(s||'').toString().trim().toLowerCase().replace(/\s+/g,' ');
    const sample=(a,n)=>{const x=[...a]; const out=[]; while(x.length&&out.length<n){ out.push(x.splice((Math.random()*x.length)|0,1)[0]) } return out };
    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[a[i],a[j]]=[a[j]]}return a};
    const parseTags=t=>!t?[]:Array.isArray(t)?t:String(t).split(/;|,/).map(s=>s.trim()).filter(Boolean);
    
    // CSV 파싱 함수는 원본 유지 (데이터 로드에 필요)
    const parseGoogleCSV = (txt, type) => {
      if (!txt) return [];
      const lines = txt.split(/\r?\n/);
      const headers = {
        'blogs': ['id', 'title', 'body', 'date', 'category'],
        'sets': ['q', 'a', 'e', 'img', 'tags', 'set', 'modality', 'set_desc', 'group']
      };
      
      let dataLines = [];
      let inQuote = false;
      let currentLine = '';

      lines.forEach(line => {
        let quoteCount = (line.match(/"/g) || []).length;
        
        if (inQuote) {
          currentLine += '\n' + line;
        } else {
          currentLine = line;
        }
        
        if (quoteCount % 2 !== 0) {
          inQuote = !inQuote;
        }

        if (!inQuote && currentLine.trim() !== '') {
          dataLines.push(currentLine);
        }
      });

      if (dataLines.length <= 1) return []; // 첫 번째 줄은 항상 헤더로 간주하고 제외

      const contentLines = dataLines.slice(1);

      const out = [];
      contentLines.forEach(line => {
        const cols = [];
        let cur = '';
        let q = false;
        for(let i=0; i<line.length; i++){
          const ch = line[i];
          if(ch==='"' && line[i+1]==='"'){
            cur += '"';
            i++;
          } else if(ch==='"'){
            q = !q;
          } else if(ch===',' && !q){
            cols.push(cur.trim());
            cur = '';
          } else {
            cur += ch;
          }
        }
        cols.push(cur.trim());

        const row = {};
        headers[type].forEach((h, idx) => {
          row[h] = cols[idx] || '';
        });
        out.push(row);
      });
      
      return out;
    };
    
    const ph=label=>{ const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='720' height='420'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#e5e7eb'/><stop offset='1' stop-color='#cbd5e1'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><g fill='#1f2937' font-family='Arial' text-anchor='middle'><text x='50%' y='50%' font-size='22' font-weight='700'>${esc(label)}</text><text x='50%' y='58%' font-size='12' fill='#6b7280'>Demo Placeholder</text></g></svg>`; return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); };

    // ====== TTS ======
    const tts = { synth: window.speechSynthesis, state: 'idle',
      speak(text){
        try{
          if(!text||!this.synth) return;
          if(this.synth.speaking){ this.synth.cancel(); }
          const u=new SpeechSynthesisUtterance(text);
          u.lang='ko-KR';
          u.onend=()=>{ this.state='idle'; updateTTSLabels(); };
          this.synth.speak(u);
          this.state='speaking';
          updateTTSLabels();
        }catch(e){}
      },
      toggle(text){
        if(this.state==='speaking'){ this.pause(); return; }
        if(this.state==='paused'){ this.resume(); return; }
        this.speak(text);
      },
      pause(){ try{ this.synth.pause(); this.state='paused'; updateTTSLabels(); }catch(e){} },
      resume(){ try{ this.synth.resume(); this.state='speaking'; updateTTSLabels(); }catch(e){} },
      stop(){ try{ this.synth.cancel(); this.state='idle'; updateTTSLabels(); }catch(e){} }
    };
    function updateTTSLabels(){
      $$('.btn.round[data-action="tts-body"]').forEach(b=>{ b.textContent = (tts.state==='speaking')? '❚❚' : (tts.state==='paused'? '▶' : '▶'); });
      $$('.btn.round[data-action="tts-stop"]').forEach(b=> b.textContent='■');
    }
    
    // ====== Markdown / 텍스트 변환 ======
    const markdown = (src = '') => {
      let s = marked.parse(src);
      markdown.headings = [];
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = s;
      
      const headings = tempDiv.querySelectorAll('h1, h2, h3, h4');
      headings.forEach((h, i) => {
        const id = slug(h.textContent) + '-' + i;
        h.id = id;
        markdown.headings.push({ id, level: parseInt(h.tagName[1]), text: h.textContent });
      });

      return tempDiv.innerHTML;
    };
    
    const toPlainText = (md='')=>{
      const tmp = document.createElement('div'); tmp.innerHTML = markdown(md||'');
      return (tmp.textContent||'').replace(/\s+\n/g,'\n');
    };

    // ====== 데모 데이터 ======
    let DemoSets = [];
    let BlogPosts = [];
    const SetsFilters = { group: '', modality: '', tags: [] };
    const BlogsFilters = { category: [], sort: 'desc', showAllCategories: false, filtersOpen: true, listOpen: true, tocOpen: true, sidebarOpen: true }; 

    // ====== 테마 ======
    const Theme={
      toggle(){
        document.documentElement.classList.toggle('dark');
        const isDark=document.documentElement.classList.contains('dark');
        $('#theme-btn').textContent=isDark?'🌙':'☀️';
        // note(isDark?'다크 모드 적용':'라이트 모드 적용'); // 요청 5: 메시지 삭제
        localStorage.setItem('theme', isDark?'dark':'light');
      },
      init(){
        const saved=localStorage.getItem('theme');
        if(saved==='dark'){ document.documentElement.classList.add('dark'); $('#theme-btn').textContent='🌙'; }
        else { $('#theme-btn').textContent='☀️'; }
      }
    };

    // ====== 사이드 메뉴 (햄버거) ======
    const Menu = {
      toggle(e){
        const menu = $('#side-menu');
        const overlay = $('#menu-overlay');
        const isCurrentlyOpen = menu.classList.contains('open');
        
        // ☰ 버튼 클릭 시
        if (e && e.target.closest('#menu-toggle-btn')) {
             if (isCurrentlyOpen) {
                 Menu.close();
             } else {
                 menu.classList.add('open');
                 overlay.classList.add('open');
             }
             return;
        }

        // 서비스 메뉴 외 공간을 누르면 닫기
        if (isCurrentlyOpen && !menu.contains(e.target) && e.target !== $('#menu-toggle-btn')) {
             Menu.close();
        }
      },
      close(){
        const menu = $('#side-menu');
        const overlay = $('#menu-overlay');
        menu.classList.remove('open');
        overlay.classList.remove('open');
      }
    }
    
    // 외부 클릭 시 메뉴 닫기 핸들러 (toggle 함수에서 처리)
    document.addEventListener('click', (e) => {
        // 메뉴 토글 버튼 클릭은 toggle 함수에서 처리
        if (!e.target.closest('[data-action="toggle-menu"]')) {
             Menu.toggle(e);
        }
    });

    // ====== 라우팅 ======
    function routeTo(view, params={}){
      // Flashcard 자동 재생 중지
      if(document.getElementById('view-flash')?.classList.contains('active') && view!=='flash'){ Flash.stopAutoplay(); }
      
      // 뷰가 변경되면 사이드 메뉴 닫기 
      Menu.close(); 
      
      $$('section.view').forEach(s=>s.classList.remove('active'));
      $('#view-'+view)?.classList.add('active');
      $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.nav===view));
      routeTo.params = params;
      if(view==='home')  renderHome();
      if(view==='sets')  renderSetList();
      if(view==='flash') Flash.mount();
      if(view==='quiz')  Quiz.mount();
      if(view==='blog')  Blog.render();
      history.replaceState(null, '', '#'+view);
    }
    window.addEventListener('hashchange',()=>{ const v=(location.hash||'#home').slice(1); routeTo(v, routeTo.params||{}); });

    const homeStats=()=>({ sets: DemoSets.length, cards: DemoSets.reduce((n,s)=>n+(s.cards?.length||0),0), blogs: BlogPosts.length });
    function renderHome(){
      const st=homeStats();
      $('#home-stats').innerHTML = [
        `<span class='stat'>세트 <b>${st.sets}</b></span>`,
        `<span class='stat'>카드 <b>${st.cards}</b></span>`,
        `<span class='stat'>칼럼 <b>${st.blogs}</b></span>`
      ].join(' ');
      
      const recommendedSets = sample(DemoSets, 6);
      $('#home-reco').innerHTML = recommendedSets.map(s=>tile(s)).join('');
      
      const latest = [...BlogPosts].sort((a,b)=>b.when-a.when).slice(0,6)
        .map(p=>`<a class='card' href="#blog" data-action="blog-select" data-id="${p.id}" style='padding:12px;'>
          <!-- 요청 1: 칼럼 제목 크기 키우기 위해 font-size:var(--fs-body) 적용 -->
          <div style='font-weight:900; font-size:var(--fs-body);'>${esc(p.title)}</div>
          <div class='muted' style='font-size:var(--fs-small); margin-bottom:6px;'>${mdDate(p.when)}${p.category? ' · '+esc(p.category):''}</div>
          <div class='muted' style='font-size:var(--fs-small); overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;'>
            ${esc(toPlainText(p.body||'').slice(0,180))}...
          </div>
        </a>`).join('');
      $('#home-blog-list').innerHTML = latest || '<div class="card muted">글이 없습니다.</div>';
    }
    function tile(s){
      const tags = (s.tags||[]).slice(0,3).map(t=>`<span class='chip'>#${esc(t)}</span>`).join('');
      const count = (s.cards?.length||0);
      const mod = s.modality||'Mixed';
      const thumb = '' 
    
      return `<div class='set-tile' data-id='${s.id}'>
        ${thumb}
        <div class='tile-body'>
          <div style='display:flex;align-items:center;gap:8px;justify-content:space-between'>
            <div style='font-weight:900; font-size:16px'>${esc(s.title)}</div>
            <span class='chip'><span class='card-count'>🃏 ${count}장</span></span>
          </div>
          <div style='display:flex;gap:8px;margin-top:6px'>
            <button class='btn primary' data-action='start-mode' data-mode='flash' data-id='${s.id}'>Flash</button>
            <button class='btn' data-action='start-mode' data-mode='quiz' data-id='${s.id}'>Quiz</button>
          </div>
        </div>
      </div>`;
    }
    function uniqueGroups(){ const set = new Set((DemoSets||[]).map(s=> (s.group||'').trim()).filter(Boolean)); return Array.from(set).sort(); }
    function uniqueModalities(){ const set = new Set((DemoSets||[]).map(s=> (s.modality||'').trim()).filter(Boolean)); return Array.from(set).sort(); }
    function uniqueSetsTags(){ const allTags = DemoSets.flatMap(s => (s.tags || [])).filter(t => t.trim() !== ''); const tagCounts = {}; allTags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1); return Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]); }

    function renderSetFilters(){
        // 과목 필터
        const groups = uniqueGroups();
        const groupSelect = $('#group');
        groupSelect.innerHTML = '<option value="">전체</option>' + groups.map(g => `<option value="${esc(g)}" ${SetsFilters.group === g ? 'selected' : ''}>${esc(g)}</option>`).join('');
        
        // 분류 필터
        const mods = uniqueModalities();
        const modSelect = $('#mod');
        modSelect.innerHTML = '<option value="">전체</option>' + mods.map(m => `<option value="${esc(m)}" ${SetsFilters.modality === m ? 'selected' : ''}>${esc(m)}</option>`).join('');
        
        // 태그 필터 (버튼형)
        const tags = uniqueSetsTags();
        const tagsList = $('#tag-filter-list');
        tagsList.innerHTML = tags.map(t => `<button class="btn small filter ${SetsFilters.tags.includes(t) ? 'active' : ''}" data-action="filter-tag" data-filter-value="${esc(t)}">#${esc(t)}</button>`).join('');
    }

    function renderSetList(){
      renderSetFilters();
      const q = $('#q')?.value?.trim().toLowerCase()||'';
      const groupFilter = SetsFilters.group;
      const modFilter = SetsFilters.modality;
      const activeTags = SetsFilters.tags;

      const list = DemoSets.filter(s=>{
        const bag=[s.title,s.desc,s.modality,s.group,(s.tags||[]).join(' '),(s.cards||[]).map(c=>[c.q,c.a,(c.tags||[]).join(' ')].join(' ')).join(' ')].join(' ').toLowerCase();
        const okQ=!q||bag.includes(q);
        const okG=!groupFilter|| norm(s.group)===norm(groupFilter);
        const okM=!modFilter|| norm(s.modality)===norm(modFilter);
        const okT=activeTags.length===0 || activeTags.every(t => (s.tags||[]).includes(t));
        
        return okQ && okG && okM && okT;
      });
      $('#set-list').innerHTML = list.map(s => tile(s)).join('') || '<div class="card muted">조건에 맞는 세트가 없습니다.</div>';
    }

    // ====== Flash ======
    let CurrentSet = null;
    const Flash={ i:0, flipped:false, order:[], bins:[[],[],[],[],[]], setId:null, countdownId:null, autoNext:true, autoNextDelay:5000, autoplay:false,
      mount(){
        if(!CurrentSet) CurrentSet=DemoSets[0];
        $('#flash-title').textContent=CurrentSet?.title||'';
        if(this.setId!==CurrentSet?.id){ this.reset(); }
        const labels=['1회차','2회차','3회차','4회차','5회차'];
        $('#bins').innerHTML = labels.map((lb)=>`
          <div class="bin">
            <div class="bin-bar"><i style="width:0%"></i></div>
            <div class="muted" style="font-size:var(--fs-tiny);margin-top:4px">${lb}</div>
            <div style="font-weight:900;font-size:var(--fs-body)">0</div>
          </div>`).join('');
        $('#auto-next').checked = this.autoNext;
        $('#auto-next-delay').value = String(this.autoNextDelay);
        $('#autoplay-btn').textContent = this.autoplay ? '❚❚' : '▶';
        this.render();
        if(!CurrentSet?.cards?.length){ note('이 세트에는 카드가 없습니다.', true); }
      },
      reset(){ this.setId=CurrentSet?.id||null; this.order = (CurrentSet?.cards||[]).map((_,i)=>i); this.bins=[[],[],[],[],[]]; this.bins[0]=[...this.order]; this.i=0; this.flipped=false; this.stopTimer(); this.render(); },
      card(){ return CurrentSet?.cards?.[this.order[this.i]]; },
      showFront(){ 
          this.flipped=false;
          const fc=$('#flash-card'); 
          fc.classList.remove('show-back'); 
          fc.classList.add('show-front'); 
          const b=$('#flash-back'); 
          if(b) b.style.display='none'; 
      },
      // 정답 공개 시 질문과 정답이 함께 보이도록
      showBack(){ 
          this.flipped=true; 
          const fc=$('#flash-card'); 
          fc.classList.remove('show-front'); 
          fc.classList.add('show-back');
          const b=$('#flash-back'); 
          if(b) b.style.display='block';
          note('정답 공개!'); // 요청 5: note 함수에서 메시지 필터링
      },
      toggle(){ this.flipped? this.showFront() : this.showBack(); this.stopTimer(); },
      next(){
        const total = this.order.length;
        let attempts = 0;
        do{
          if(this.i<total-1) this.i++; else this.i=0;
          attempts++;
          const idx=this.order[this.i];
          const where=this.binOf(idx);
          if(where < 4) break;
          if(attempts>total) break;
        }while(true);
        this.flipped=false; this.stopTimer(); this.render();
      },
      prev(){ if(this.i>0){ this.i--; this.flipped=false; this.stopTimer(); this.render(); } },
      binOf(idx){ return this.bins.findIndex(b=>b.includes(idx)); },
      moveBin(idx, to){ let from=this.binOf(idx); if(from<0) from=0; this.bins[from]=this.bins[from].filter(x=>x!==idx); this.bins[to].push(idx); },
      grade(ok){
        if(!CurrentSet) return;
        const idx=this.order[this.i];
        let from=this.binOf(idx); if(from<0) from=0;
        const to= ok? Math.min(from+1,4):0;
        this.moveBin(idx, to);
        note(ok? '✓ 알았다':'× 몰랐다'); // 요청 5: note 함수에서 메시지 필터링
        this.next(); this.renderBins();
        if(this.autoplay && this.allMastered()) this.stopAutoplay(true);
      },
      startTimer(){
        this.stopTimer(); this.showFront();
        let t = +$('#timer-select').value;
        const cd=$('#countdown'); cd.textContent=t; cd.classList.add('show');
        this.countdownId = setInterval(()=>{
          t--; cd.textContent=t;
          if(t<=0){
            clearInterval(this.countdownId); this.countdownId=null;
            cd.classList.remove('show');
            this.showBack();
            if($('#auto-next').checked){
              const delay = +($('#auto-next-delay').value||this.autoNextDelay);
              setTimeout(()=> {
                if(this.autoplay){
                  this.next();
                  if(this.allMastered()) this.stopAutoplay(true); else this.startTimer();
                } else {
                  this.next();
                }
              }, delay || 5000);
            }
          }
        },1000);
      },
      stopTimer(){ const cd=$('#countdown'); if(cd){ cd.textContent=''; cd.classList.remove('show'); } if(this.countdownId){ clearInterval(this.countdownId); this.countdownId=null; } },
      render(){
        this.stopTimer();
        if(!CurrentSet?.cards?.length){
          $('#flash-img').src=''; $('#flash-answer').textContent=''; $('#flash-explain').textContent='카드가 없습니다.'; $('#flash-pos').textContent='0/0'; $('#flash-bar').style.width='0%';
          $('#flash-card').classList.add('show-front'); return;
        }
        const k=this.card(); if(!k) return;
        $('#flash-img').src=k.img||ph('No image');
        $('#flash-question').textContent = k.q || '이 영상의 진단명은?';
        $('#flash-answer').innerHTML=`<span>${esc(k.a||'')}</span>`;
        $('#flash-explain').innerHTML=`<span>${esc(k.e||'')}</span>`;
        $('#flash-pos').textContent=`${this.i+1}/${this.order.length}`;
        $('#flash-bar').style.width=((this.i+1)/this.order.length*100|0)+'%';
        this.renderBins();
        this.showFront();
      },
      renderBins(){ const binEls = $$('#bins .bin'); const total = CurrentSet?.cards?.length||0; this.bins.forEach((b,i)=>{ const el=binEls[i]; if(!el||!total) return; el.querySelector('.bin-bar i').style.width = `${(b.length/total)*100}%`; el.querySelector('div:last-child').textContent = b.length; }); },
      toggleAutoplay(){
        this.autoplay = !this.autoplay;
        $('#autoplay-btn').textContent = this.autoplay ? '❚❚' : '▶︎';
        if(this.autoplay){
          $('#auto-next').checked = true;
          const firstUnsolved = this.order.findIndex(idx => this.binOf(idx) < 4);
          if(firstUnsolved>=0) this.i = firstUnsolved;
          this.startTimer();
        }else{ this.stopTimer(); }
      },
      stopAutoplay(done=false){ this.autoplay=false; $('#autoplay-btn').textContent = '▶'; this.stopTimer(); if(done) note('모든 카드 5회차 완료! 자동 진행 종료'); },
      allMastered(){ return this.order.every(idx => this.binOf(idx)===4); }
    };

    // ====== Quiz ======
    const Quiz={ sheet:[], i:0, score:0,
      mount(){ 
        if(!CurrentSet) CurrentSet=DemoSets[0]; 
        $('#quiz-title').textContent=(CurrentSet?.title||'')+' – Quiz'; 
        $('#quiz-stage').style.display='none'; 
        $('#quiz-controls').style.display='block'; // 컨트롤 보이기
      },
      start(){
        if(!CurrentSet?.cards?.length){ note('이 세트에 카드가 없어 퀴즈를 시작할 수 없습니다.', true); return; }
        const mode=$('#quiz-mode').value; const n=+$('#quiz-n').value;
        const pool=[...(CurrentSet?.cards||[])];
        this.sheet = sample(pool, Math.min(n,pool.length)).map(c=> makeQ(mode,c));
        this.i=0; this.score=0; 
        $('#quiz-controls').style.display='none'; // 요청 2: 시작 후 컨트롤 숨기기
        this.render();
      },
      cur(){ return this.sheet[this.i]; },
      render(){
        const q=this.cur(); const stage=$('#quiz-stage'); stage.style.display='block';
        stage.innerHTML = `
        <div class='muted' style='display:flex;gap:8px;align-items:center;margin-bottom:8px; font-size: var(--fs-small);'>
          문항 <b>${this.i+1}/${this.sheet.length}</b>
          <span style='margin-left:auto; font-size: var(--fs-small); font-weight: 700;'>점수 <b>${this.score}</b></span>
        </div>
        <div style='display:grid;gap:10px'>
          ${q?.image?`<img src='${q.image}' alt='x-ray' style="max-height:360px; object-fit:contain"/>`:''}
          <!-- 요청 2: 문제 폰트 크기/두께 조정 -->
          <div style='font-weight:500; font-size:var(--fs-h1);'>
            <span>${esc(q?.stem||'')}</span>
          </div>
          <div id='quiz-opts' class='grid' style="gap:8px"></div>
          <div id='quiz-exp' class='muted' style='display:none; font-size: var(--fs-small);'></div>
          <div style='display:flex;gap:8px'>
            <button class='btn' data-action='quiz-prev'>이전</button>
            <button class='btn primary' data-action='quiz-next'>다음</button>
          </div>
        </div>`;
        const wrap=$('#quiz-opts');
        if(!q) return;
        if(q.kind==='mc'||q.kind==='tf'){
          q.options.forEach((opt,idx)=>{ const el=document.createElement('div'); el.className='opt'; el.textContent=opt; el.dataset.action='quiz-pick'; el.dataset.idx=idx; wrap.appendChild(el); });
        } else {
          const input=document.createElement('input'); input.placeholder='정답 입력'; input.style.cssText='padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--text); font-size: var(--fs-small);';
          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='확인'; btn.dataset.action='quiz-fill';
          wrap.appendChild(input); wrap.appendChild(btn);
        }
      },
      pick(idx){ const q=this.cur(); const nodes=$$('#quiz-opts .opt'); nodes.forEach((n,i)=>{n.dataset.action=''; n.classList.toggle('correct', i===q.answerIndex); if(i===idx && i!==q.answerIndex) n.classList.add('wrong');}); if(idx===q.answerIndex){this.score++; note('정답!');} else {note('오답');} this.explain(); },
      fillCheck(val){ const q=this.cur(); const ok = norm(val)===norm(q.answerText); if(ok){this.score++; note('정답!');} else {note('오답');} this.explain(ok?undefined:`정답: ${q.answerText}`); },
      explain(extra){ const q=this.cur(); const exp=$('#quiz-exp'); exp.style.display='block'; exp.textContent = (extra? extra+ ' · ' : '') + (q.explain||''); },
      next(){ if(this.i<this.sheet.length-1){ this.i++; this.render(); } else this.finish(); },
      prev(){ if(this.i>0){ this.i--; this.render(); } },
      finish(){ 
        const acc=((this.score/this.sheet.length)*100|0); 
        $('#quiz-stage').innerHTML = `<div style='font-size:var(--fs-h2);font-weight:900;margin-bottom:6px'>퀴즈 완료!</div><div class='muted' style='font-size: var(--fs-body);'>최종 점수</div><div style='font-weight:900;margin:6px 0 14px; font-size: var(--fs-h1);'>${this.score}/${this.sheet.length} (${acc}%)</div><div style='display:flex;gap:8px'><button class='btn primary' data-action='quiz-restart'>다시 풀기</button><button class='btn' data-action='start-mode' data-mode='flash'>Flash 복습</button></div>`; 
        $('#quiz-controls').style.display='block'; // 종료 후 컨트롤 다시 보이기
      }
    };
    function makeQ(mode, k){
      if(mode==='tf'){ const truth = Math.random()<0.5; const others = DemoSets.flatMap(s=>s.cards).filter(x=>x!==k); const alt = others.length? sample(others,1)[0] : k; const text = truth ? k.a : alt.a; const stem = '이 영상의 진단명은 ' + esc(text) + ' 이다.'; return {kind:'tf', stem, image:k.img, explain:k.e, options:['O','X'], answerIndex: truth?0:1}; }
      if(mode==='fill'){ return {kind:'fill', stem:'아래 영상의 진단명을 입력하세요.', image:k.img, explain:k.e, answerText:k.a}; }
      const others = DemoSets.flatMap(s=>s.cards).filter(x=>x!==k); const picks = sample(others, Math.min(3, others.length)).map(o=>o.a); const opts = [...picks, k.a]; shuffle(opts); return {kind:'mc', stem:'아래 영상의 진단명은?', image:k.img, explain:k.e, options:opts, answerIndex:opts.indexOf(k.a)};
    }

    // ====== Blog ======
    const Blog={ curId:null, blogList:[],
      new(){ /* 관리자 기능 제거 */ },
      select(id){ 
        this.curId=id; 
        const p=BlogPosts.find(x=>x.id===id); 
        if(!p) return; 
        this.renderView(p); 
        $$('#blog-list a').forEach(el => el.classList.toggle('active', el.dataset.id === id));
        this.updateNavButtons(id);
      },
      renderView(p){
        const htmlBody = markdown(p.body || '');
        const html = `<h1>${esc(p.title)}</h1><div class="muted" style="margin-bottom:12px">${mdDate(p.when)}${p.category? ' · '+esc(p.category):''}</div>`+ htmlBody; 
        $('#blog-view').innerHTML=html;
        Blog.renderTOC();
      },
      updateNavButtons(currentId){
        const list = this.blogList;
        const currentIndex = list.findIndex(p => p.id === currentId);
        const prevPost = list[currentIndex - 1];
        const nextPost = list[currentIndex + 1];
        const prevBtn = $('#blog-prev-btn');
        const nextBtn = $('#blog-next-btn');

        if (prevPost) {
            prevBtn.style.visibility = 'visible';
            prevBtn.dataset.id = prevPost.id;
            prevBtn.textContent = `← ${esc(prevPost.title)}`;
        } else {
            prevBtn.style.visibility = 'hidden';
            prevBtn.textContent = '← ';
        }
        if (nextPost) {
            nextBtn.style.visibility = 'visible';
            nextBtn.dataset.id = nextPost.id;
            nextBtn.textContent = `${esc(nextPost.title)} →`;
        } else {
            nextBtn.style.visibility = 'hidden';
            nextBtn.textContent = ' →';
        }
      },
      prev(){
        const list = this.blogList;
        const currentIndex = list.findIndex(p => p.id === this.curId);
        if (currentIndex > 0) {
            this.select(list[currentIndex - 1].id);
        }
      },
      next(){
        const list = this.blogList;
        const currentIndex = list.findIndex(p => p.id === this.curId);
        if (currentIndex < list.length - 1) {
            this.select(list[currentIndex + 1].id);
        }
      },
      renderTOC(){
        const toc = markdown.headings;
        const el=$('#blog-toc');
        const btn = $('#blog-toc-toggle-btn');
        
        if(!toc.length || !BlogsFilters.tocOpen){
            el.style.display='none';
            el.innerHTML='';
            btn.textContent = '▾';
            return;
        }

        let h='<ul>';
        let prev = 1;
        toc.forEach(({id, level, text})=>{
            if(level>prev) h+='<ul>';
            else if(level<prev) h+='</ul>'.repeat(prev-level);
            h+=`<li><a href="javascript:void(0)" data-action="toc-goto" data-target="${id}">${esc(text)}</a></li>`;
            prev=level;
        });
        h+='</ul>'.repeat(prev)+'</ul>';
        el.innerHTML=h;
        el.style.display='block';
        btn.textContent = '▴';
      },
      editStart(){ /* 관리자 기능 제거 */ },
      save(){ /* 관리자 기능 제거 */ },
      cancel(){ /* 관리자 기능 제거 */ },
      delete(){ /* 관리자 기능 제거 */ },
      showEditor(show){ /* 관리자 기능 제거 */ },
      render(){
        const q = ($('#blog-q')?.value||'').toLowerCase();
        const sort = $('#blog-sort')?.value || BlogsFilters.sort; // 실제 정렬 값 사용
        BlogsFilters.sort = sort; // 필터 상태 업데이트
        const categories = BlogsFilters.category;
        const filtersDiv = $('#blog-filters');
        const listUl = $('#blog-list');
        const filtersBtn = $('#blog-filters-toggle-btn');
        const listBtn = $('#blog-list-toggle-btn');
        const sidebarEl = $('#blog-sidebar');
        const sidebarBtn = $('#blog-sidebar-toggle-btn');

        let list = [...BlogPosts].filter(p=>!q|| p.title.toLowerCase().includes(q)||p.body.toLowerCase().includes(q));
        if (categories.length > 0) {
            list = list.filter(p => {
                const postCategories = (p.category || '').split(/;|,/).map(c => c.trim()).filter(c => c !== '');
                return categories.every(c => postCategories.includes(c));
            });
        }

        list.sort((a,b) => {
            if (sort === 'desc') return b.when - a.when;
            else return a.when - b.when;
        });
        this.blogList = list;

        // 필터/목록 토글 상태 반영
        filtersDiv.style.display = BlogsFilters.filtersOpen ? 'block' : 'none';
        filtersBtn.textContent = BlogsFilters.filtersOpen ? '▴' : '▾';
        
        if(BlogsFilters.listOpen) {
            listUl.innerHTML = list.map(p=>`<li><a data-action='blog-select' data-id='${p.id}'>${esc(p.title)}</a></li>`).join('') || '<div class="muted" style="padding:8px">글이 없습니다.</div>';
            listUl.style.display = 'block';
            listBtn.textContent = '▴';
        } else {
            listUl.innerHTML = '';
            listUl.style.display = 'none';
            listBtn.textContent = '▾';
        }
        
        // 사이드바 토글 상태 반영
        sidebarEl.classList.toggle('collapsed', !BlogsFilters.sidebarOpen);
        sidebarBtn.textContent = BlogsFilters.sidebarOpen ? '▾' : '▴';

        this.renderTOC(); 

        if(this.curId){ 
            const p = list.find(x=>x.id===this.curId);
            if(p) this.select(this.curId);
            else if (list.length > 0) this.select(list[0].id);
        } else if (list.length > 0) { 
            this.select(list[0].id);
        } else { 
            $('#blog-view').innerHTML = '';
            $('#blog-toc').style.display = 'none';
            $('#blog-prev-btn').style.visibility = 'hidden';
            $('#blog-next-btn').style.visibility = 'hidden';
        }
        renderHome();
        this.renderFilters();
      },
      speakBody(){ const p=BlogPosts.find(x=>x.id===this.curId); if(!p) return; const text = toPlainText(p.body||''); if(!text.trim()) { note('읽을 본문이 없습니다.'); return; } tts.toggle(text); },
      stopSpeak(){ tts.stop(); },
      toggleSidebar(){
        BlogsFilters.sidebarOpen = !BlogsFilters.sidebarOpen;
        this.render();
      },
      toggleFilters(){
          BlogsFilters.filtersOpen = !BlogsFilters.filtersOpen;
          this.render();
      },
      toggleList(){
        BlogsFilters.listOpen = !BlogsFilters.listOpen;
        this.render();
      },
      toggleTOC(){
        BlogsFilters.tocOpen = !BlogsFilters.tocOpen;
        this.render();
      },
      checkKey(){ return false; /* 관리자 기능 제거 */ },
      
      renderFilters(){
          const allCategories = [...new Set(BlogPosts.flatMap(p => (p.category || '').split(/;|,/).map(c => c.trim()).filter(c => c !== '')))];
          const filterList = $('#category-filter-list');
          let displayCategories = allCategories;
          let toggleButton = '';
          if (allCategories.length > VISIBLE_CATEGORIES_LIMIT) {
              if (!BlogsFilters.showAllCategories) {
                  displayCategories = allCategories.slice(0, VISIBLE_CATEGORIES_LIMIT);
                  toggleButton = `<button class="btn small" data-action="toggle-categories">전체</button>`;
              } else {
                  toggleButton = `<button class="btn small" data-action="toggle-categories">접기</button>`;
              }
          }

          filterList.innerHTML = displayCategories.map(c => `<button class="btn small filter ${BlogsFilters.category.includes(c) ? 'active' : ''}" data-action="filter-category" data-filter-value="${esc(c)}">${esc(c)}</button>`).join('') + toggleButton;
      }
    };

    // ====== Admin (기능은 유지하되 UI에서 숨김) ======
    const Admin={ 
        mount(){ logDev('Admin functions intentionally disabled in UI.'); },
        resetConfirm(){ 
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; display:grid; place-items:center;';
            modal.innerHTML = `
                <div class="card" style="padding:20px; max-width:320px; text-align:center;">
                    <div style="font-weight:700; margin-bottom:12px;">정말 모든 데이터를 초기화할까요?</div>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="btn bad" data-modal-action="confirm-reset">확인</button>
                        <button class="btn" data-modal-action="cancel-reset">취소</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('[data-modal-action="confirm-reset"]').addEventListener('click', () => {
                document.body.removeChild(modal);
                localStorage.clear(); 
                location.reload();
            });
            modal.querySelector('[data-modal-action="cancel-reset"]').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        },
        remoteReload(){ return remoteReload(); } // 원격 로드 기능은 유지
    };
    
    // ====== 상태 저장 ======
    const KEY='dentblog_state_v1';
    const persist=()=>{ try{ localStorage.setItem(KEY, JSON.stringify({sets:DemoSets, blogs:BlogPosts})); }catch(e){ } };
    function restoreLocal(){
      const raw=localStorage.getItem(KEY);
      if(!raw) return false;
      try{
        const st=JSON.parse(raw);
        if(st.sets) {
            DemoSets = st.sets.map(s => ({ 
                ...s, 
                cards: (s.cards || []).map(c => ({ ...c, img: c.img || ph(c.a || 'Card') }))
            }));
        }
        if(st.blogs) BlogPosts=st.blogs;
        return true;
      }catch(e){ return false; }
    }

    // ====== 원격 로드 ======
    const fetchText = async (url)=> (await fetch(url, {cache:'no-store'})).text();
    const fetchJSON = async (url)=> (await fetch(url, {cache:'no-store'})).json();
    const fetchBuf  = async (url)=> (await fetch(url, {cache:'no-store'})).arrayBuffer();
    
    async function tryLoadSetsFromGoogleSheet(){
      try{
        const sheetId = "1BWSJMBLuEU2v7eon5MdM02fAFHV0z5T2tr3_42K15dY";
        const gid = "66467758";
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
    
        const txt = await fetchText(url);
        const rows = parseGoogleCSV(txt, 'sets');
        if(rows.length){
          const bySet = {};
          rows.forEach(r=>{
            const setName = (r.set || '기본 세트').trim();
            if(!bySet[setName]){
              bySet[setName] = { 
                id:slug(setName), 
                modality:r.modality||'Mixed', 
                title:r.set || r.set_desc || setName, 
                desc:r.set_desc||'', 
                group:r.group||'', 
                tags:[], 
                cards:[] 
              };
            }
            if(r.q || r.a){
              bySet[setName].cards.push({ 
                q:r.q||'', 
                a:r.a||'', 
                e:r.e||'', 
                img:r.img||'', 
                tags:parseTags(r.tags) 
              });
            }
          });
          DemoSets = Object.values(bySet);
          persist(); // 로드 후 저장
          return 'sets.google';
        }
      }catch(e){
        /* console.error('sets load fail (google):', e.message||e); */
      }
      return null;
    }
    
    async function tryLoadBlogsFromGoogleSheet(){
      try{
        const sheetId = "1B9zr1SQ7ROzIgwC2k8TmuTh0KfNM2-Y_FgNclQVEFZA";
        const gid = "908527068";
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
        
        const txt = await fetchText(url);
        const rows = parseGoogleCSV(txt, 'blogs');
        if(rows.length){
          BlogPosts = rows.map(r=>({
            id: r.id || uid(),
            title: r.title || '',
            body: r.body || '',
            when: r.date ? +new Date(r.date) : Date.now(),
            category: r.category || ''
          }));
          persist(); // 로드 후 저장
          return 'blogs.google';
        }
      }catch(e){
        /* console.error('blogs load fail (google):', e.message||e); */
      }
      return null;
    }
    
    async function remoteReload(){
      busy(true,'원격 데이터 확인 중...');
      const a = await tryLoadSetsFromGoogleSheet();
      const b = await tryLoadBlogsFromGoogleSheet();
      busy(false, (a||b)? '원격 데이터 적용 완료' : '원격 데이터 없음');
    }

    // ====== 이벤트 위임 ======
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-action],[data-nav]');
      
      // 요청 1: 메뉴 토글 버튼 클릭은 toggle 함수에서 처리, 나머지 공간 클릭도 toggle 함수에서 처리
      if (!el || el.dataset.action === 'toggle-menu') {
          Menu.toggle(e);
      }

      const nav = el?.dataset.nav;
      if(nav){ routeTo(nav); return; }

      const act = el?.dataset.action;

      // 공통
      if(act==='toggle-theme'){ Theme.toggle(); return; }
      // toggle-menu는 위에서 처리됨

      // 세트/모드
      if(act==='start-mode'){
        const id = el.dataset.id;
        CurrentSet = DemoSets.find(s=>s.id===id) || DemoSets[0];
        if(el.dataset.mode==='flash') routeTo('flash');
        else routeTo('quiz');
        return;
      }
      if(act==='filter-tag'){
          const tag = el.dataset.filterValue;
          const index = SetsFilters.tags.indexOf(tag);
          if (index > -1) {
              SetsFilters.tags.splice(index, 1);
          } else {
              SetsFilters.tags.push(tag);
          }
          el.classList.toggle('active');
          renderSetList();
          return;
      }

      // Flash
      if(act==='flash-next'){ Flash.next(); return; }
      if(act==='flash-prev'){ Flash.prev(); return; }
      if(act==='flash-toggle'){ Flash.toggle(); return; }
      if(act==='flash-grade'){ Flash.grade( el.dataset.ok==='1' ); return; }
      if(act==='start-timer'){ Flash.startTimer(); return; }
      if(act==='flash-autoplay'){ Flash.toggleAutoplay(); return; }

      // Quiz
      if(act==='quiz-start'){ Quiz.start(); return; }
      if(act==='quiz-next'){ Quiz.next(); return; }
      if(act==='quiz-prev'){ Quiz.prev(); return; }
      if(act==='quiz-restart'){ Quiz.start(); return; }
      if(act==='quiz-pick'){ const idx = +el.dataset.idx; Quiz.pick(idx); return; }
      if(act==='quiz-fill'){ const val = $('#quiz-opts input')?.value||''; Quiz.fillCheck(val); return; }
      if(act==='tts-toggle'){ const t = el.dataset.text||''; tts.toggle(t); return; }
      if(act==='tts-stop'){ tts.stop(); return; }

      // Blog
      if(act==='blog-select'){ const id=el.dataset.id; Blog.select(id); return; }
      if(act==='blog-prev'){ Blog.prev(); return; }
      if(act==='blog-next'){ Blog.next(); return; }
      if(act==='blog-list-toggle'){ Blog.toggleList(); return; }
      if(act==='blog-filters-toggle'){ Blog.toggleFilters(); return; }
      if(act==='blog-toc-toggle'){ Blog.toggleTOC(); return; }
      if(act==='blog-sidebar-toggle'){ Blog.toggleSidebar(); return; }
      if(act==='toggle-categories'){
          BlogsFilters.showAllCategories = !BlogsFilters.showAllCategories;
          Blog.renderFilters();
          return;
      }
      if(act==='toc-goto'){ const id=el.dataset.target; const t=document.getElementById(id); if(t) t.scrollIntoView({behavior:'smooth', block:'start'}); return; }
      if(act==='tts-body'){ Blog.speakBody(); return; }
      if(act==='filter-category'){
          const category = el.dataset.filterValue;
          const index = BlogsFilters.category.indexOf(category);
          if (index > -1) {
              BlogsFilters.category.splice(index, 1);
          } else {
              BlogsFilters.category.push(category);
          }
          el.classList.toggle('active');
          Blog.render();
          return;
      }


      // Admin (remoteReload만 유지)
      if(act==='remote-reload'){ Admin.remoteReload(); return; }
    });

    // 입력 이벤트
    $('#q')?.addEventListener('input', renderSetList);
    $('#group')?.addEventListener('change', (e) => {
      SetsFilters.group = e.target.value;
      renderSetList();
    });
    $('#mod')?.addEventListener('change', (e) => {
      SetsFilters.modality = e.target.value;
      renderSetList();
    });
    $('#blog-q')?.addEventListener('input', ()=> Blog.render());
    
    // Blog Sort가 헤더 컨트롤로 이동됨: input 이벤트 리스너를 추가
    $('#blog-sort')?.addEventListener('change', (e) => {
        BlogsFilters.sort = e.target.value;
        Blog.render();
    });

    // 키보드 단축키 (Flash)
    window.addEventListener('keydown',(e)=>{
      const isFlash = $('#view-flash')?.classList.contains('active');
      if(!isFlash) return;
      if(e.code==='Space'){ e.preventDefault(); Flash.toggle(); }
      if(e.key==='ArrowRight'){ Flash.next(); }
      if(e.key==='ArrowLeft'){ Flash.prev(); }
    });

    // ====== 부트스트랩 ======
    (async function init(){
      Theme.init();
      restoreLocal();
      await remoteReload();
      routeTo((location.hash||'#home').slice(1)||'home');
      updateTTSLabels();
    })();
  </script>
</body>
</html>
