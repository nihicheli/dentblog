<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dent Study</title>
  <style>
    :root{
      --bg:#f8fafc;
      --fg:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --card:#ffffff;
      --brand:#2563eb;
      --brand-2:#1e40af;
      --ok:#16a34a;
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Apple Color Emoji,Segoe UI Emoji}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
    .nav{display:flex;gap:12px;align-items:center}
    .nav a{padding:8px 12px;border-radius:10px}
    .nav a.active{background:var(--fg);color:#fff}
    .nav a.admin{display:none !important;} /* 주소는 유지(#admin), 네비만 숨김 */
    main .wrap{padding:16px}
    h1{font-size:22px;margin:0 0 12px}
    h2{font-size:18px;margin:18px 0 10px}
    .grid{display:grid;gap:12px}
    .grid.cards{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .shadow{box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card .thumb{aspect-ratio:16/9;background:#eef2ff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width=\"400\" height=\"225\"><rect width=\"100%\" height=\"100%\" fill=\"%23eef2ff\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%2381a1ff\" font-size=\"16\">미리보기 없음</text></svg>') center/contain no-repeat}
    .card .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .card .body{padding:12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .filters{display:flex;gap:10px}
    .select{display:flex;gap:8px;align-items:center}
    select.input{appearance:auto; /* 이중 화살표 제거(네이티브만) */ }
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
    .tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#f8fafc}
    .pill{padding:4px 8px;background:#eef2ff;border-radius:999px;color:#1e3a8a}
    .hidden{display:none !important}
    .korean{word-break:keep-all}
    .center{display:flex;align-items:center;justify-content:center}
    .badge{font-size:12px;color:#475569}
    .hr{height:1px;background:var(--line);margin:12px 0}
    /* Flash / Quiz */
    .qa{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
    .qa .q{font-weight:600}
    .qa .a{margin-top:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <a href="#home" id="nav-home">홈</a>
      <a href="#sets" id="nav-sets">학습세트</a>
      <a href="#blogs" id="nav-blogs">블로그</a>
      <a href="#admin" id="nav-admin" class="admin">관리</a> <!-- 숨김, 주소만 유지 -->
      <div style="margin-left:auto" class="row">
        <input id="global-q" class="input" placeholder="검색 (세트/블로그)" style="width:220px">
        <button class="btn" id="btn-search">검색</button>
      </div>
    </div>
  </header>
  <main>
    <div class="wrap" id="view"></div>
  </main>

<script>
/* ========================
   설정: Google Sheets 연결
======================== */
const SHEETS = {
  blogs: { id: '1B9zr1SQ7ROzIgwC2k8TmuTh0KfNM2-Y_FgNclQVEFZA', gid: '908527068' },
  sets:  { id: '1BWSJMBLuEU2v7eon5MdM02fAFHV0z5T2tr3_42K15dY', gid: '66467758' }
};

/* ============ 전역 상태 ============ */
let DemoSets = [];     // [{id,title,desc,group,modality,cards:[{q,a,e,img,tags[]}]}]
let BlogPosts = [];    // [{id,title,body,when,category}]
const State = { route:'home', param:null, q:'' };

/* ============ 유틸 ============ */
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
const uid = ()=> Math.random().toString(36).slice(2,9) + Date.now().toString(36).slice(4);
const slug = s=>(s||'').toString().normalize('NFKD').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-').toLowerCase();
const ph = (t='Card')=>{
  const txt = encodeURIComponent((t||'').slice(0,18) || 'Card');
  return `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="338"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="%23eef2ff"/><stop offset="1" stop-color="%23e2e8f0"/></linearGradient></defs><rect width="100%" height="100%" fill="url(%23g)"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%2364758b" font-size="24" font-family="sans-serif">${txt}</text></svg>`;
};
const logDev = (...args)=> console.debug('[DEV]', ...args);
const note = (m)=> console.log(m);
const fmtDate = ms=>{
  try{const d=new Date(ms); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  catch{ return '' }
};
function parseTags(s){
  if(!s) return [];
  return s.split(/[,;]+/).map(x=>x.trim()).filter(Boolean);
}

/* Robust CSV parser (honors quotes, commas, newlines in fields) */
function parseCSV(text){
  const rows=[]; let row=[], i=0, s=text, val='', q=false;
  const push=()=>{ row.push(val); val=''; };
  const endrow=()=>{ push(); rows.push(row); row=[]; };
  while(i<s.length){
    const c=s[i];
    if(q){
      if(c==='"' && s[i+1]==='"'){ val+='"'; i+=2; continue; }
      if(c==='"'){ q=false; i++; continue; }
      val+=c; i++; continue;
    }else{
      if(c==='"'){ q=true; i++; continue; }
      if(c===','){ push(); i++; continue; }
      if(c==='\r'){ i++; continue; }
      if(c==='\n'){ endrow(); i++; continue; }
      val+=c; i++; continue;
    }
  }
  if(val.length || row.length) endrow();
  if(!rows.length) return [];
  const headers = rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r=> r.some(c=>String(c).trim().length)).map(cols=>{
    const obj={};
    headers.forEach((h,idx)=> obj[h]= (cols[idx]??'').toString().trim());
    return obj;
  });
}

/* 네트워크 */
async function fetchText(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(res.status+' '+res.statusText);
  return await res.text();
}
async function loadSheetCSV({id,gid}){
  const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&gid=${gid}`;
  const txt = await fetchText(url);
  return parseCSV(txt);
}

/* 세트: 평평한 행 → 화면이 쓰는 묶음 구조로 변환 */
function csvRowsToSets(rows){
  const map=new Map();
  (rows||[]).forEach(r=>{
    const title = (r.set||'unnamed').trim();
    const id = slug(title);
    if(!map.has(id)){
      map.set(id, {
        id,
        modality: r.modality || 'Mixed',
        title,
        desc: r.set_desc || '',
        tags: [],
        group: r.group || '',
        cards: []
      });
    }
    map.get(id).cards.push({
      q: r.q || '',
      a: r.a || '',
      e: r.e || '',
      img: r.img || '',
      tags: parseTags(r.tags)
    });
  });
  const sets = Array.from(map.values()).map(s=>{
    s.cards = (s.cards||[]).map(c => ({ ...c, img: c.img || ph(c.a||'Card') }));
    return s;
  });
  replaceSets(sets);
}

/* 세트 교체 & 렌더 */
function replaceSets(newSets){
  if(!Array.isArray(newSets)) return;
  DemoSets.length = 0;
  newSets.forEach(s=> DemoSets.push(s));
  renderSetList(); renderHome();
  note('세트가 원격 데이터로 갱신되었습니다.');
}

/* 로컬 저장 (known 상태 등) */
function persist(){
  try{
    const known = {};
    DemoSets.forEach(s=>{
      const k = localStorage.getItem('known:'+s.id);
      if(k) known[s.id]=JSON.parse(k);
    });
    localStorage.setItem('state:known-index', JSON.stringify(known));
  }catch{}
}
function restoreLocal(){
  // (필요 시 확장) 현재는 known만 세트별 키로 사용하므로 자동 복원 없음
}

/* ========= 데이터 로더 ========= */
async function tryLoadSets(){
  try{
    const rows = await loadSheetCSV(SHEETS.sets);
    if(rows.length){
      csvRowsToSets(rows);
      logDev('sets <- google sheet', rows.length);
      return true;
    }
  }catch(e){
    logDev('sets load fail', e.message||e);
  }
  return false;
}
async function tryLoadBlogs(){
  try{
    const rows = await loadSheetCSV(SHEETS.blogs);
    if(rows.length){
      BlogPosts = rows.map(r=>({
        id: r.id || uid(),
        title: r.title || '',
        body: r.body || '',
        when: r.date ? +new Date(r.date) : Date.now(),
        category: r.category || r.cat || r.tags || ''
      }));
      logDev('blogs <- google sheet', rows.length);
      return true;
    }
  }catch(e){
    logDev('blogs load fail', e.message||e);
  }
  return false;
}

/* ========= 라우팅 ========= */
function setActiveNav(){
  $$('.nav a').forEach(a=>a.classList.remove('active'));
  const el = $('#nav-'+State.route);
  if(el) el.classList.add('active');
}
function routeTo(hash){
  const [route, param] = hash.split('/'); 
  State.route = route || 'home';
  State.param = param || null;
  setActiveNav();
  if(State.route==='home') renderHome();
  else if(State.route==='sets') renderSetList();
  else if(State.route==='blogs') renderBlogs();
  else if(State.route==='flash') renderFlash(State.param);
  else if(State.route==='quiz') renderQuiz(State.param);
  else if(State.route==='admin') renderAdmin();
  else renderHome();
}
window.addEventListener('hashchange', ()=> routeTo((location.hash||'#home').slice(1)));

/* ========= 렌더 ========= */
function renderHome(){
  const v = $('#view');
  const rec = DemoSets.slice(0,6);
  const latestBlogs = [...BlogPosts].sort((a,b)=>b.when-a.when).slice(0,4);
  v.innerHTML = `
    <h1>추천 세트</h1>
    <div class="grid cards">
      ${rec.map(s=>{
        const img = (s.cards[0] && s.cards[0].img) ? s.cards[0].img : ph(s.title);
        return `
        <div class="card shadow">
          <div class="thumb">${img?`<img src="${img}" alt="">`:''}</div>
          <div class="body">
            <div class="row wrap" style="justify-content:space-between">
              <div>
                <div class="badge">${s.group||''}${s.group && s.modality?' · ':''}${s.modality||''}</div>
                <div style="font-weight:600;margin-top:4px">${s.title}</div>
              </div>
              <div class="row">
                <a class="btn" href="#flash/${s.id}">Flash</a>
                <a class="btn" href="#quiz/${s.id}">Quiz</a>
              </div>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>

    <h1 class="mt24">최신 블로그</h1>
    <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr))">
      ${latestBlogs.map(b=>`
        <div class="card shadow">
          <div class="body">
            <div class="badge">${fmtDate(b.when)} · ${b.category||'칼럼'}</div>
            <div style="font-weight:700;margin-top:6px">${b.title}</div>
            <div class="muted mt8" style="display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden">${b.body}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderSetList(){
  const v = $('#view');
  const groups = {};
  DemoSets.forEach(s=>{
    const g = s.group||'기타';
    (groups[g]??=[]).push(s);
  });

  v.innerHTML = `
    <h1>학습 세트</h1>
    <div class="card shadow" style="margin-bottom:12px">
      <div class="body">
        <div class="filters">
          <input id="q-sets" class="input" placeholder="세트 검색(제목/설명/태그)">
          <div class="select">
            <span class="label">구분</span>
            <select id="mod" class="input">
              <option value="">전체</option>
              <option value="Panorama">Panorama</option>
              <option value="CBCT">CBCT</option>
              <option value="Mixed">Mixed</option>
              <option value="Pathology">Pathology</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    ${Object.entries(groups).map(([g,sets])=>{
      return `
        <h2>${g}</h2>
        <div class="grid cards" data-group="${g}">
          ${sets.map(s=>{
            const img = (s.cards[0] && s.cards[0].img) ? s.cards[0].img : ph(s.title);
            return `
            <div class="card shadow" data-title="${s.title}" data-desc="${s.desc}" data-mod="${s.modality}">
              <div class="thumb">${img?`<img src="${img}" alt="">`:''}</div>
              <div class="body">
                <div class="badge">${s.modality||''}</div>
                <div style="font-weight:700;margin:6px 0 2px">${s.title}</div>
                ${s.desc?`<div class="muted" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${s.desc}</div>`:''}
                <div class="row mt12">
                  <a class="btn" href="#flash/${s.id}">Flash</a>
                  <a class="btn" href="#quiz/${s.id}">Quiz</a>
                </div>
              </div>
            </div>`;
          }).join('')}
        </div>
      `;
    }).join('')}
  `;

  // 필터 이벤트
  $('#q-sets').addEventListener('input', applySetFilter);
  $('#mod').addEventListener('change', applySetFilter);
  function applySetFilter(){
    const q = $('#q-sets').value.trim().toLowerCase();
    const mod = $('#mod').value;
    $$('.grid.cards .card', v).forEach(card=>{
      const t = (card.getAttribute('data-title')+' '+card.getAttribute('data-desc')).toLowerCase();
      const okQ = !q || t.includes(q);
      const okM = !mod || (card.getAttribute('data-mod')===mod);
      card.style.display = (okQ && okM) ? '' : 'none';
    });
  }
}

function renderBlogs(){
  const v = $('#view');
  v.innerHTML = `
    <h1>블로그</h1>
    <div class="card shadow">
      <div class="body">
        <input id="q-blog" class="input" placeholder="블로그 검색(제목/본문/카테고리)">
      </div>
    </div>
    <div id="blog-list"></div>
  `;
  const list = $('#blog-list');

  function draw(items){
    list.innerHTML = `
      <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(320px,1fr))">
        ${items.map(b=>`
          <div class="card shadow">
            <div class="body">
              <div class="badge">${fmtDate(b.when)} · ${b.category||'칼럼'}</div>
              <div style="font-weight:700;margin-top:6px">${b.title}</div>
              <div class="muted mt8" style="display:-webkit-box;-webkit-line-clamp:6;-webkit-box-orient:vertical;overflow:hidden">${b.body}</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  draw([...BlogPosts].sort((a,b)=>b.when-a.when));

  $('#q-blog').addEventListener('input', e=>{
    const q=e.target.value.trim().toLowerCase();
    const items = BlogPosts.filter(b=>
      (!q) ||
      (b.title||'').toLowerCase().includes(q) ||
      (b.body||'').toLowerCase().includes(q) ||
      (b.category||'').toLowerCase().includes(q)
    );
    draw(items);
  });
}

/* ===== Flash ===== */
function getSetById(id){ return DemoSets.find(s=>s.id===id); }
function getKnownMap(id){
  try{
    return JSON.parse(localStorage.getItem('known:'+id)||'{}');
  }catch{ return {}; }
}
function setKnown(id,map){
  try{
    localStorage.setItem('known:'+id, JSON.stringify(map||{}));
  }catch{}
}

function renderFlash(id){
  const s = getSetById(id);
  if(!s){ $('#view').innerHTML=`<p>세트를 찾을 수 없습니다.</p>`; return; }

  const v = $('#view');
  const known = getKnownMap(id); // idx: true
  let idx = 0;
  const order = s.cards.map((_,i)=>i);

  // 다음 "미학습" 카드 인덱스 찾기
  function nextIndex(cur){
    for(let k=1;k<=order.length;k++){
      const i=(cur+k)%order.length;
      if(!known[i]) return i;
    }
    return -1; // 모두 학습됨
  }
  function remainingCount(){
    return order.filter(i=>!known[i]).length;
  }
  function draw(i){
    const c = s.cards[i];
    const rest = remainingCount();
    v.innerHTML = `
      <div class="row wrap" style="justify-content:space-between">
        <h1>${s.title}</h1>
        <div class="row"><span class="pill">남은 카드: ${rest}</span></div>
      </div>
      <div class="qa mt12">
        <div class="q korean">${c.q||'(질문 없음)'}</div>
        ${c.img? `<div class="mt12"><img src="${c.img}" alt="" style="max-width:100%;border-radius:12px;border:1px solid var(--line)"></div>`:''}
        <div class="a muted mt12 hidden" id="ans">${c.a||''}${c.e?`\n\n${c.e}`:''}</div>
        <div class="row mt16">
          <button class="btn" id="btn-show">정답 보기</button>
          <button class="btn ok" id="btn-know">알았다</button>
          <button class="btn ghost" id="btn-skip">다음</button>
        </div>
      </div>
    `;
    $('#btn-show').onclick=()=> $('#ans').classList.remove('hidden');
    $('#btn-know').onclick=()=>{
      known[i]=true;
      setKnown(id, known);
      const ni = nextIndex(i);
      if(ni===-1){
        v.innerHTML = `
          <div class="center" style="min-height:40vh;flex-direction:column;gap:12px">
            <div style="font-size:22px;font-weight:700">🎉 완료!</div>
            <div class="muted">모든 카드를 ‘알았다’로 표시했습니다.</div>
            <div class="row mt12">
              <a class="btn" href="#sets">세트 목록</a>
              <button class="btn" id="btn-reset">초기화하고 다시 하기</button>
            </div>
          </div>`;
        $('#btn-reset').onclick=()=>{ setKnown(id,{}); renderFlash(id); };
      }else{
        draw(ni); // ✅ 자동으로 다음 미학습 카드로 이동
      }
    };
    $('#btn-skip').onclick=()=>{
      const ni = nextIndex(i);
      draw(ni===-1 ? i : ni); // 모두 학습이면 그대로
    };
  }
  const start = nextIndex(-1);
  if(start===-1){
    // 이미 모두 학습됨
    setKnown(id,{}); // 자동 리셋 (원하면 제거)
    draw(0);
  }else{
    draw(start);
  }
}

/* ===== Quiz (간단 텍스트형; 오디오/녹음 없음) ===== */
function renderQuiz(id){
  const s=getSetById(id);
  if(!s){ $('#view').innerHTML=`<p>세트를 찾을 수 없습니다.</p>`; return; }
  const v = $('#view');
  let i=0;
  function draw(){
    const c=s.cards[i];
    v.innerHTML = `
      <div class="row wrap" style="justify-content:space-between">
        <h1>${s.title} · Quiz</h1>
        <div class="row"><span class="pill">${i+1} / ${s.cards.length}</span></div>
      </div>
      <div class="qa mt12">
        <div class="q korean">${c.q||'(질문 없음)'}</div>
        ${c.img? `<div class="mt12"><img src="${c.img}" alt="" style="max-width:100%;border-radius:12px;border:1px solid var(--line)"></div>`:''}
        <input id="ans" class="input mt12" placeholder="정답을 생각해 보세요. (정답 보기 버튼으로 확인)">
        <div class="row mt12">
          <button class="btn" id="btn-reveal">정답 보기</button>
          <button class="btn" id="btn-prev">이전</button>
          <button class="btn" id="btn-next">다음</button>
        </div>
        <div class="qa mt12 hidden" id="reveal">
          <div class="a"><b>정답:</b> ${c.a||''}${c.e?`<br><span class="muted">${c.e}</span>`:''}</div>
        </div>
      </div>
    `;
    $('#btn-reveal').onclick=()=> $('#reveal').classList.remove('hidden');
    $('#btn-prev').onclick=()=>{ i=(i-1+s.cards.length)%s.cards.length; draw(); };
    $('#btn-next').onclick=()=>{ i=(i+1)%s.cards.length; draw(); };
  }
  draw();
}

/* ===== Admin (주소만 유지) ===== */
function renderAdmin(){
  $('#view').innerHTML = `
    <h1>관리</h1>
    <div class="muted">이 페이지는 주소로만 접근 가능하고, 네비게이션에는 표시되지 않습니다.</div>
    <div class="hr"></div>
    <div class="card shadow">
      <div class="body">
        <div>세트/블로그는 Google Sheets를 수정하면 즉시 반영됩니다.</div>
        <div class="mt8"><code>sets</code> 헤더: q, a, e, img, tags, set, modality, set_desc, group</div>
        <div class="mt8"><code>blogs</code> 헤더: id, title, body, date, category</div>
      </div>
    </div>
  `;
}

/* ========= 초기화 ========= */
document.addEventListener('DOMContentLoaded', async ()=>{
  restoreLocal();
  await Promise.allSettled([ tryLoadSets(), tryLoadBlogs() ]);
  routeTo((location.hash||'#home').slice(1));

  // 글로벌 검색
  $('#btn-search').onclick = ()=>{
    const q = $('#global-q').value.trim().toLowerCase();
    if(!q){ location.hash='#home'; return; }
    // 우선 세트로
    location.hash='#sets';
    setTimeout(()=>{
      const input = $('#q-sets'); if(input){ input.value=q; input.dispatchEvent(new Event('input')); }
    }, 0);
  };
});
</script>
</body>
</html>
