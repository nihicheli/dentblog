<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🦷DentBlog | 치의학 블로그</title>
  <meta name="description" content="치의학 영상·일반 학습을 위한 플래시카드 · 퀴즈 · 칼럼" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root{
      /* 색상 및 디자인 톤 조정: 전체적으로 밝고 부드럽게 */
      --bg:#f9fafc; --panel:#ffffff; --panel-2:#f0f2f5; --text:#1e293b; 
      --muted:#64748b; /* 부드러운 회색 */
      --line:#e2e8f0; /* 밝은 라인 색상 */
      --brand:#1e293b; /* DentBlog와 버튼 색상 (어두운 검정색 계열) */
      --brand-2:#334155; 
      --ok:#10b981; --bad:#ef4444; --warn:#f59e0b;
      --radius:10px; --shadow:0 6px 15px rgba(30,41,59,.06); --maxw:1120px;
      /* 폰트 크기 정의 */
      --fs-hero: clamp(24px, 2.4vw, 32px); /* 제목 크기 축소 */
      --fs-h1: clamp(20px, 2vw, 28px); /* H1 크기 축소 */
      --fs-h2: clamp(16px, 1.6vw, 20px); 
      --fs-h3: clamp(14px, 1.4vw, 18px); 
      --fs-body: clamp(14px, 1.2vw, 16px);
      --fs-small: clamp(12px, 1vw, 14px); /* 작은 요소 폰트 */
      --fs-xsmall: clamp(11px, 0.9vw, 13px); /* 필터 라벨, 알았다/몰랐다, 홈 미리보기 폰트 크기 */
      --header-brand-size: clamp(18px, 2vw, 24px); /* DentBlog 폰트 크기 조정 */
    }
    
    /* 모바일 폰트 최적화 */
    @media (max-width: 768px) {
        :root {
            --fs-hero: 22px;
            --fs-h1: 18px;
            --fs-h2: 16px;
            --fs-body: 13px;
            --fs-small: 12px;
            --fs-xsmall: 11px;
            --header-brand-size: 16px;
        }
    }
    
    html.dark{
      --bg:#0f172a; --panel:#1e293b; --panel-2:#334155; --text:#f1f5f9; --muted:#94a3b8; --line:#374151;
      --brand:#f1f5f9; --brand-2:#cbd5e1; --ok:#4ade80; --bad:#f87171; --warn:#facc15;
    }
    *{box-sizing:border-box; font-weight: 500;} 
    html,body{height:100%}
    body{
      margin:0; font:500 var(--fs-body)/1.65 "Pretendard","Inter","Segoe UI",system-ui,-apple-system,sans-serif;
      background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      transition:background-color .25s, color .25s;
    }
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    button{cursor:pointer; font-family:inherit}
    
    /* 폰트 및 필터 UI 통일 */
    .filter-group select,
    .filters input#q,
    .sets input#q-header, /* 검색창 */
    #timer-select, 
    #auto-next-delay,
    #blog-sort {
        font-size: var(--fs-small);
        padding: 8px 12px;
        border-radius: var(--radius);
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--text);
        line-height: normal;
        /* 높이 통일을 위한 최소 높이 설정 */
        min-height: 38px;
    }
    .filter-group .label {
        font-size: var(--fs-xsmall); /* 필터 라벨 폰트 크기 */
        font-weight: 700;
    }
    /* 타이머 드롭다운 높이 통일 */
    #timer-select, #auto-next-delay {
        padding: 6px 12px;
        min-height: 34px;
    }
    /* 통계 폰트 조정 */
    #home-stats .stat,
    .stat .card-count,
    #flash-pos {
        font-size: var(--fs-small); 
        font-weight: 700;
        padding: 6px 10px; 
        border-radius: var(--radius);
        background: var(--panel);
        border: 1px solid var(--line);
    }
    .stat b {
        font-size: var(--fs-body); 
        font-weight: 700;
    }
    .set-tile .chip {
        font-size: 11px; 
        padding: 3px 8px;
    }
    
    header{position:sticky;top:0;z-index:50;background:color-mix(in oklab, var(--panel) 88%, transparent);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
    .nav{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;letter-spacing:.1px; color:var(--brand)}
    .brand div{ font-size: var(--header-brand-size); font-weight: 700;} /* DentBlog 폰트 두께 및 크기 조정 */
    .brand .logo{font-size:22px; line-height:1}
    .tabs{margin-left:auto;display:flex;gap:6px}
    .tab{padding:10px 14px;border-radius:var(--radius);background:var(--panel); color:var(--muted); font-weight:700; box-shadow:0 1px 0 var(--line) inset; transition:all .15s}
    .tab.active{background:var(--brand); color:#fff}
    /* 4. 다크모드에서 클릭된 탭 색상 수정 */
    html.dark .tab.active{background:var(--brand-2); color:var(--text);}
    
    .theme{margin-left:6px;border:none;border-radius:var(--radius);padding:10px 12px;background:var(--panel); box-shadow:0 1px 0 var(--line) inset; color:var(--muted)}

    main{max-width:var(--maxw);margin:0 auto;padding:18px}
    section.view{display:none}
    section.view.active{display:block}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px; transition:background-color .2s, border-color .2s}
    .shadow{box-shadow:var(--shadow)}
    .muted{color:var(--muted)}

    /* 버튼 크기 조정 및 디자인 롤백 */
    .btn{border:none;background:linear-gradient(180deg,#ffffff,#f8fafc);color:#0b1020;border-radius:var(--radius);padding:10px 14px; font-weight:700; box-shadow:0 1px 0 rgba(0,0,0,.04) inset; transition:transform .08s ease;}
    .btn:active{transform:translateY(1px)}
    html.dark .btn{background:var(--panel); color:var(--text)}
    
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; padding: 8px 12px; font-size: var(--fs-body);}
    .btn.ok{background:linear-gradient(180deg,#34d399,#10b981);color:#fff; padding: 8px 12px; font-size: var(--fs-xsmall);} /* 알았다/몰랐다 폰트 크기 조정 */
    .btn.bad{background:linear-gradient(180deg,#fca5a5,#ef4444);color:#fff; padding: 8px 12px; font-size: var(--fs-xsmall);} /* 알았다/몰랐다 폰트 크기 조정 */
    
    .btn.small {
        padding: 6px 10px;
        font-size: var(--fs-small);
    }
    .btn.round{padding: 6px 8px;}

    .btn.filter{
        /* 태그 필터 디자인 롤백 */
        background: var(--panel-2); 
        color: var(--muted); 
        box-shadow: 0 1px 0 var(--line) inset; 
        transition: all .15s
    }
    .btn.filter.active{
        background: var(--brand); 
        color: #fff;
        box-shadow: 0 1px 0 var(--line) inset; 
    }
    html.dark .btn.filter.active{background:var(--brand-2); color:var(--text)}

    .btn-nav{border:none;background:var(--panel);color:var(--text);border-radius:var(--radius);padding:10px 12px;display:inline-flex;align-items:center;gap:6px;font-weight:700;box-shadow:0 1px 0 var(--line) inset;transition:transform .08s}
    .btn-nav:active{transform:translateY(1px)}

    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#eef2ff;color:var(--brand);font-size:12px}
    html.dark .chip{background:var(--panel-2); color:var(--text)}
    
    /* 홈 화면 그리드 비율 조정 */
    .home > div:nth-child(3) { 
        display:grid; 
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); /* 1:1 비율 유지 */
        gap:12px; 
    }
    @media (max-width: 768px) {
        .home > div:nth-child(3) { 
            grid-template-columns: 1fr;
            gap: 16px; 
        }
    }
    .grid{display:grid;gap:12px}
    .hero{display:grid;gap:8px;margin:6px 0 14px;text-align:center;padding: 16px 0;}
    .hero h1{margin:0;font-size:var(--fs-hero); font-weight:900}
    .hero p{margin:0 auto; max-width:780px; font-size: clamp(15px, 1.3vw, 18px)}
    .stat{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:var(--radius);background:var(--panel);border:1px solid var(--line); font-weight:500;}

    .typing{
        display: inline-block;
        overflow: hidden;
        white-space: nowrap;
        border-right: 2px solid var(--brand);
        animation: typing 4s steps(40,end) 1, caret 1s step-end infinite;
    }
    @keyframes typing{ from{width:0} to{width:100%} }
    @keyframes caret{ 50%{border-color:transparent} }

    .set-tile{
        display:flex;
        gap:14px; 
        cursor:pointer; 
        padding:12px; 
        border:1px solid var(--line); 
        border-radius:var(--radius); 
        background:var(--panel);
        /* 홈 목록 깨짐 방지 */
        min-width: 0; 
    }
    .set-tile:hover{background:var(--panel-2)}
    
    .tile-body{flex:1;display:grid;gap:6px; min-width: 0;}

    .progress{height:10px;background:#e5e7eb;border:1px solid #d1d5db;border-radius:999px;overflow:hidden}
    html.dark .progress{background:var(--panel-2);border-color:var(--line)}
    .progress>i{display:block;height:100%;background:#111827}

    .flash-frame{display:grid; grid-template-columns:1fr 1fr; gap:16px; box-shadow:var(--shadow)}
    .flash-frame > .card { order: 3; } 
    
    .flash-visual{display:flex; justify-content:center; align-items:center; padding:16px; order: 1;}
    .flash-visual img{max-height:420px; width:100%; height:auto; object-fit:contain}

    .flash-card{position:relative; padding:12px; cursor:pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; order: 2;}
    
    .flash-card .front{
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--line);
        background: var(--panel);
        text-align: center;
        word-wrap: break-word;
        line-height: 1.5;
        width: 100%;
        min-height: 120px;
        transition: border-radius .2s;
    }
    .flash-card .back {
        display: none; 
        background: var(--panel-2); 
        padding: 12px;
        border-radius: var(--radius);
        margin-top: 10px;
        border: 1px solid var(--line);
        width: 100%;
        text-align: center; 
    }
    .flash-card.show-back .back { display: block; }
    .flash-card.show-back .front .hint { display: none !important; } 

    /* Flashcard 모바일 최적화 */
    @media (max-width: 900px) {
        .flash-frame {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .flash-frame > .card { order: 4; } /* 채점/타이머 카드는 가장 아래로 */
        .flash-visual { order: 1; }
        .flash-card { order: 2; }
    }

    /* 퀴즈 최종 점수 크기 조정 */
    .quiz-result-score {
        font-size: clamp(24px, 4vw, 36px) !important; /* 크기 한 단계 더 축소 */
        font-weight: 700;
        margin: 6px 0 14px !important;
    }

    .hint{ font-size:var(--fs-small); color:var(--muted) }
    .countdown{position:absolute; inset:0; display:grid; place-items:center;background:rgba(0,0,0,.55); color:#fff; font-size:48px; font-weight:900;border-radius:var(--radius); opacity:0; transition:opacity .2s;pointer-events:none; z-index:2;}
    .countdown.show{ opacity:1; pointer-items:auto }

    .bin{ text-align:center }
    .bin-bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;}
    .bin-bar i{height:100%;display:block;background:#111827; transition:width .2s ease-in-out;}

    .opt{border:1px solid var(--line);border-radius:10px;padding:12px;background:var(--panel); transition:all .2s}
    .opt:hover{border-color:#111827;background:var(--panel-2)}
    .opt.correct{border-color:var(--ok);background:color-mix(in oklab, var(--ok) 18%, transparent)}
    .opt.wrong{border-color:var(--bad);background:color-mix(in oklab, var(--bad) 18%, transparent)}

    .blog{display:grid;grid-template-columns:320px 1fr;gap:16px; min-height:600px}
    @media (max-width:980px){.blog{grid-template-columns:1fr}}
    .blog-sidebar{position:sticky; top:84px; align-self:flex-start; max-height:calc(100vh - 120px); overflow-y:auto; padding:0;}
    
    /* 글 목록 <li> 스타일 */
    .blog-list{list-style:none;padding:0;margin:0}
    .blog-list a{display:block;padding:10px 12px;border-radius:var(--radius);color:var(--muted);border:1px solid transparent; font-weight: 500;}
    .blog-list a:hover{background:var(--panel-2); color:var(--text)}
    .blog-list a.active{background:var(--brand); color:#fff; font-weight:700; border-color:transparent}
    
    .blog-view{padding:18px;min-height:160px; background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow)}
    .blog-view h1{font-size:var(--fs-h1);margin:.2em 0 .5em; border-bottom:1px solid var(--line); padding-bottom:8px}
    .blog-view h2{font-size:var(--fs-h2);margin:1.3em 0 .4em; border-bottom:none; padding-bottom:0}
    .blog-view h3{font-size:var(--fs-h3);margin:1em 0 .4em}
    .editor input,.editor textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text)}
    .editor textarea{min-height:180px;margin-bottom:8px}
    
    /* TOC 스타일 */
    .toc{margin-top:12px;font-size:var(--fs-small)}
    .toc ul{list-style:none;padding-left:0; margin: 6px 0 0;}
    .toc li{margin:6px 0 0 0;padding-left:12px;border-left:1px dashed var(--line)}
    .toc a{color:var(--muted); font-weight: 500;}
    .toc a:hover{color:var(--text)}
    
    /* 푸터 스타일 */
    footer {
        margin: 32px auto;
        color: var(--muted); 
        text-align: center;
        padding: 12px 0;
        border-top: 1px solid var(--line);
        max-width: var(--maxw);
    }
    footer a {
        font-size: var(--fs-small);
        font-weight: 500;
    }
    
    /* 세트 필터 레이아웃 조정 */
    .sets .filters {
        display: flex;
        flex-direction: column; 
        gap: 4px; /* 상하 간격: 4px로 최종 조정 */
    }
    .sets .filters .filter-group {
        gap: 8px;
        align-items: center;
    }
    .sets .filters .filter-group.inline-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }
    .sets .filters > input#q {
        width: 100%;
    }

    @media (min-width: 600px) {
        .sets .filters .filter-group.inline-group {
            flex-direction: row; 
        }
        .sets .filters .filter-group {
            display: flex;
            align-items: center;
        }
    }
    @media (max-width: 599px) {
        .sets .filters .filter-group.inline-group {
            flex-direction: column;
            gap: 8px;
        }
        .sets .filters .filter-group {
            width: 100%;
            justify-content: space-between;
        }
    }
    
    /* 칼럼 탐색 버튼 정렬 */
    #blog-nav-buttons {
        display: flex; 
        justify-content: space-between; 
    }
    #blog-prev-btn { 
        text-align: left !important; 
        margin-right: auto;
    }
    #blog-next-btn { 
        text-align: right !important; 
        margin-left: auto;
    }
    
    /* 글 목록 토글 기능 관련 스타일 */
    .blog-toggle-area {
        overflow: hidden;
        transition: all 0.3s ease-out;
    }
    .blog-toggle-area.collapsed {
        max-height: 0 !important; /* height 대신 max-height 사용 */
        padding-top: 0 !important;
        margin-top: 0 !important;
        border-top: none !important;
    }

  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand" data-nav="home" role="button" aria-label="홈으로 이동">
        <div class="logo">🦷</div><div>DentBlog</div>
      </div>
      <div class="tabs" role="tablist">
        <a class="tab" data-nav="home" role="tab" aria-selected="true">홈</a>
        <a class="tab" data-nav="sets" role="tab">세트</a>
        <a class="tab" data-nav="blog" role="tab">칼럼</a>
        <a class="tab" data-nav="admin" role="tab">관리</a>
      </div>
      <style>
        [data-nav="admin"] { display:none !important; }
      </style>
      <button id="theme-btn" class="theme" data-action="toggle-theme" aria-label="테마 전환">🌠</button>
    </div>
  </header>

  <main>
    <section id="view-home" class="view active home">
      <div class="hero">
        <h1>치의학 블로그</h1>
        <p class="typing">플래시카드·퀴즈·칼럼으로 치의학을 쉽게 학습하세요.</p>
        <div id="home-stats" class="chips" style="justify-content:center; gap:8px"></div>
      </div>

      <div class="card shadow" style="padding:0; overflow:hidden; margin-bottom:12px">
        <div style="display:flex; overflow:auto; gap:12px; padding:12px;">
          <img src="https://via.placeholder.com/1100x120/222222/ffffff?text=BANNER+1" alt="배너" style="width:100%; min-width:320px; height:120px; object-fit:cover; border-radius:var(--radius);"/>
        </div>
      </div>

      <div style="display:grid; grid-template-columns:minmax(0, 1fr) minmax(0, 1fr); gap:12px;"> <!-- 1:1 비율 유지 -->
        <div class="card shadow">
          <div class="muted" style="font-weight:700;margin-bottom:8px">추천 세트</div>
          <div id="home-reco" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(320px,1fr));"></div>
        </div>
        <div class="card shadow">
          <div class="muted" style="font-weight:700;margin-bottom:8px">칼럼 최신</div>
          <div id="home-blog-list" class="grid" style="grid-template-columns:1fr; gap:8px;"></div>
        </div>
      </div>
    </section>

    <section id="view-sets" class="view sets">
      <div class="hero" style="text-align:left; display: flex; align-items: center; justify-content: space-between;">
        <h1 style="font-size:var(--fs-h1); font-weight: 700; margin: 0;">학습 세트</h1>
        <!-- 검색창을 제목 옆으로 이동 -->
        <div style="display: flex; align-items: center; gap: 8px;">
          <input id="q-header" placeholder="검색" style="padding:8px 12px;border-radius:var(--radius);border:1px solid var(--line);background:var(--panel);color:var(--text); min-width: 150px; font-size: var(--fs-small);"/>
        </div>
      </div>
      <div class="card shadow" style="margin-bottom:12px">
        <div class="filters" style="padding: 12px 0;">
            <!-- 과목/분류 (같은 행, 높이 정렬됨) -->
            <div class="filter-group inline-group" style="align-items: flex-start; gap: 16px;">
                <div class="filter-group">
                    <label for="group" class="label">과목</label>
                    <select id="group"></select>
                </div>
                <div class="filter-group">
                    <label for="mod" class="label">분류</label>
                    <select id="mod"></select>
                </div>
            </div>
            
            <!-- 태그 (독립된 행) -->
            <div class="filter-group" style="margin-top: 8px;">
                <label for="tags" class="label">태그</label>
                <div id="tag-filter-list" class="chips" style="margin-top: 6px;"></div>
            </div>
        </div>
      </div>
      <div id="set-list" class="grid" style="grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));"></div>
    </section>

    <section id="view-flash" class="view">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
        <div style="flex:1;">
          <h2 id="flash-title" style="margin:0; font-size:var(--fs-h1)"></h2>
        </div>
        <!-- 이전/다음 카드 버튼 -->
        <div style="display:flex;gap:8px;" id="flash-nav-buttons">
          <button class="btn-nav" data-action="flash-prev" id="flash-prev-btn" style="padding: 8px 12px; font-size: var(--fs-small);">← 이전 카드</button>
          <button class="btn-nav" data-action="flash-next" id="flash-next-btn" style="padding: 8px 12px; font-size: var(--fs-small);">다음 카드 →</button>
        </div>
      </div>

      <div class="progress"><i id="flash-bar" style="width:0%"></i></div>

      <div id="flash-frame" class="card shadow flash-frame" style="margin-top:12px">
        
        <div class="flash-visual">
          <img id="flash-img" alt="x-ray"/>
        </div>
        
        <!-- 문제 카드 (문제+정답 통합) -->
        <div class="flash-card" id="flash-card" data-action="flash-toggle" aria-label="카드를 클릭하거나 스페이스바를 눌러 정답을 확인하세요">
          <div class="front" id="flash-front">
            <div style="font-weight:700; font-size:var(--fs-h2); display:flex; flex-direction: column; align-items:center; justify-content:center; text-align:center; width: 100%;">
              <span id="flash-question">이 영상의 진단명은?</span>
              <!-- 정답 부분 -->
              <div class="back" id="flash-back" style="display: none; padding: 0; margin-top: 16px; width: 100%; border: none; background: transparent;">
                  <div class="muted" style="margin-bottom: 4px; font-size: var(--fs-small); font-weight: 700; text-align: center;">정답</div>
                  <div id="flash-answer" style="font-size:var(--fs-h2); font-weight: 700; margin:4px 0 8px; text-align: center;"></div>
                  <div id="flash-explain" class="muted" style="max-width:520px;margin:0 auto; font-size: var(--fs-body); text-align: center;"></div>
              </div>
            </div>
            <div class="hint">카드를 클릭하거나 스페이스바를 눌러 정답을 확인하세요</div>
          </div>
        </div>

        <div class="card">
          <div class="muted" style="font-weight:700;margin-bottom:8px; font-size: var(--fs-small);">채점</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ok"  data-action="flash-grade" data-ok="1">알았다</button>
            <button class="btn bad" data-action="flash-grade" data-ok="0">몰랐다</button>
          </div>
          <div id="bins" style="display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-top: 12px;"></div>
        </div>

        <div class="card">
          <div class="muted" style="font-weight:700;margin-bottom:8px; font-size: var(--fs-small);">타이머</div>
          <div style="display:flex;gap:16px;align-items:center; flex-wrap:wrap"> <!-- gap: 16px로 늘려 좌우 간격 확보 -->
            <!-- 폰트/패딩 통일 -->
            <span id="flash-pos" class="stat" style="font-weight: 700; padding: 6px 10px;">0/0</span>
            <label style="font-size: var(--fs-small);">타이머
              <select id="timer-select">
                <option value="3">3초</option>
                <option value="5" selected>5초</option>
                <option value="10">10초</option>
              </select>
            </label>
            <label style="display:inline-flex;gap:6px;align-items:center;margin-left:8px; font-size: var(--fs-small);">
              <input type="checkbox" id="auto-next" checked />
              정답 후 자동 넘김
            </label>
            <label style="font-size: var(--fs-small);">
              지연
              <select id="auto-next-delay">
                <option value="3000">3초</option>
                <option value="5000" selected>5초</option>
                <option value="7000">7초</option>
                <option value="10000">10초</option>
              </select>
            </label>

            <button class="btn round" data-action="flash-autoplay" id="autoplay-btn" aria-label="연속 자동 학습 토글">▶</button>
          </div>
        </div>
      </div>
    </section>

    <section id="view-quiz" class="view">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
        <h2 id="quiz-title" style="margin:0; font-size:var(--fs-h1)"></h2>
        <div id="quiz-nav-buttons" style="display:flex;gap:8px;">
          <button class="btn-nav" data-action="quiz-prev">← 이전</button>
          <button class="btn-nav" data-action="quiz-next">다음 →</button>
        </div>
      </div>
      <div class="card shadow" style="margin-bottom:10px">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <label>모드
            <select id="quiz-mode" style="padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a">
              <option value="tf">OX</option>
              <option value="fill">빈칸</option>
            </select>
          </label>
          <label>문항 수
            <select id="quiz-n" style="padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a">
              <option>5</option><option selected>10</option><option>15</option>
            </select>
          </label>
          <button class="btn primary" data-action="quiz-start">시작</button>
        </div>
      </div>
      <div class="card shadow" id="quiz-stage" style="display:none"></div>
    </section>

    <section id="view-blog" class="view">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h1 style="font-size:var(--fs-h1); font-weight: 700;">칼럼</h1>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <input id="blog-q" placeholder="검색" style="padding:8px 12px;border-radius:var(--radius);border:1px solid var(--line);background:var(--panel);color:var(--text); min-width: 150px; font-size: var(--fs-small);"/>
        </div>
      </div>

      <div class="blog">
        <aside class="blog-sidebar">
          <div class="card" style="padding:12px; position:sticky; top:84px; align-self:flex-start; max-height:calc(100vh - 120px); overflow-y:auto;">
            
            <!-- 정렬 및 태그 필터 토글 영역 -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px; padding-bottom:8px; border-bottom:1px solid var(--line)">
              <div style="font-weight:700; font-size:var(--fs-body);">정렬 및 태그</div>
              <button class="btn small" data-action="blog-filters-toggle" id="blog-filters-toggle-btn" title="접기/펼치기">⏶</button>
            </div>
            <div id="blog-filters" class="filters blog-toggle-area" style="margin-top:4px; display: block; gap: 4px; border-bottom: 1px solid var(--line); padding-bottom: 12px; height: auto;">
                <div class="filter-group">
                    <label for="blog-sort" class="label">정렬</label>
                    <select id="blog-sort" style="font-size: var(--fs-small);">
                        <option value="desc">최신순</option>
                        <option value="asc">오래된순</option>
                    </select>
                </div>
                <div class="filter-group" style="margin-top: 8px; display: block;">
                    <label class="label">태그</label>
                    <div id="category-filter-list" class="chips" style="margin-top: 6px;"></div>
                </div>
            </div>

            <!-- 글 목록 토글 영역 -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px; padding-top:12px; padding-bottom:8px; border-bottom:1px solid var(--line)">
              <div style="font-weight:700; font-size:var(--fs-body);">글 목록</div>
              <button class="btn small" data-action="blog-list-toggle" id="blog-list-toggle-btn" title="접기/펼치기">⏶</button>
            </div>
            
            <div id="blog-list-wrapper" class="blog-toggle-area" style="height: auto;">
                <ul id="blog-list" class="blog-list" style="margin-top:12px;"></ul>
            </div>
            
            <!-- 목차 토글 영역 -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px; padding-top:12px; padding-bottom:8px; border-bottom:1px solid var(--line)">
              <div style="font-weight:700; font-size:var(--fs-body);">목차</div>
              <button class="btn small" data-action="blog-toc-toggle" id="blog-toc-toggle-btn" title="접기/펼치기">⏶</button>
            </div>
            <div id="blog-toc-wrapper" class="blog-toggle-area" style="height: auto;">
                <div id="blog-toc" class="toc" style="display:none;"></div>
            </div>
            
          </div>
        </aside>
        <div>
          <div id="blog-view" class="blog-view"></div>
          
          <!-- 이전/다음 글 탐색 버튼 -->
          <div id="blog-nav-buttons" style="display:flex; justify-content:space-between; gap: 8px; margin-top: 12px; border-top: 1px solid var(--line); padding-top: 12px;">
            <button class="btn-nav" data-action="blog-prev" id="blog-prev-btn" style="visibility: hidden; flex-shrink: 1; text-align: left; padding: 10px; font-size: var(--fs-small); max-width: 48%;">← 이전 글</button>
            <button class="btn-nav" data-action="blog-next" id="blog-next-btn" style="visibility: hidden; flex-shrink: 1; text-align: right; padding: 10px; font-size: var(--fs-small); max-width: 48%; margin-left: auto;">다음 글 →</button>
          </div>
          <!-- /이전/다음 글 탐색 버튼 -->
          
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
            <button class="btn icon" data-action="tts-body" aria-label="본문 읽기/일시정지">▶</button>
            <button class="btn icon" data-action="tts-stop" aria-label="정지">■</button>
          </div>
          <div id="blog-editor" class="editor" style="display:none;margin-top:10px">
            <input id="blog-title" placeholder="제목" />
            <textarea id="blog-body" placeholder="내용(Markdown 지원)"></textarea>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn primary" data-action="blog-save">저장</button>
              <button class="btn" data-action="blog-cancel">취소</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-admin" class="view">
      <div class="hero" style="text-align:left">
        <h1 style="font-size:var(--fs-h1)">관리자</h1>
        <p class="muted">관리자 키는 고정되어 있습니다. 저장 기능은 없습니다.</p>
      </div>
      <div class="grid cols-2">
        <div class="card shadow">
          <h3 style="margin-top:0; font-size:var(--fs-h2)">카드 일괄 등록</h3>
          <div style="display:grid;gap:8px">
            <input id="adm-key" type="password" placeholder="관리자 키"/>
            <select id="adm-target" style="padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a"></select>
            <input id="adm-newset" placeholder="새 세트 이름(신규 생성 시)"/>
            <textarea id="adm-json" placeholder='[{"q":"문제","a":"정답","e":"해설","img":"url","tags":"CBCT;낭종"}]' rows="6"></textarea>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="adm-file" type="file" accept=".csv,.xlsx,.json"/>
              <button class="btn" data-action="adm-json">JSON 등록</button>
              <button class="btn" data-action="adm-file">파일 등록(CSV/XLSX/JSON)</button>
              <button class="btn bad" data-action="adm-reset">모든 데이터 초기화</button>
            </div>
          </div>
        </div>

        <div class="card shadow">
          <h3 style="margin-top:0; font-size:var(--fs-h2)">원격 데이터</h3>
          <div class="muted" style="margin-bottom:6px">GitHub Pages 원격 데이터 자동 탐색/적용</div>
          <div class="chips" style="margin-bottom:8px">
            <span class="chip">data/sets.(json|csv|xlsx)</span>
            <span class="chip">data/blogs.(json|csv|xlsx)</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
            <button class="btn" data-action="remote-reload">원격 데이터 새로고침</button>
          </div>
          <pre id="dev-log" class="muted" style="white-space:pre-wrap;background:var(--panel-2);border:1px solid var(--line);padding:10px;border-radius:10px;max-height:260px;overflow:auto"></pre>
        </div>

        <div class="card shadow" style="grid-column:1/-1">
          <h3 style="margin-top:0; font-size:var(--fs-h2)">CSV/XLSX 컬럼 가이드</h3>
          <div class="muted">헤더 권장. 지원 컬럼: <b>q, a, e, img, tags, set, modality, set_desc, group</b> (tags는 세미콜론; 구분) — 세트 묶음은 <b>group</b> 사용.</div>
<pre class="muted" style="white-space:pre-wrap;background:var(--panel-2);border:1px solid var(--line);padding:10px;border-radius:10px">q,a,e,img,tags,set,modality,set_desc,group
이 영상의 진단명은?,Dentigerous cyst,매복치 치관 주위 방사선투과,https://ex.com/dentigerous.jpg,Panorama;낭종,낭종 vs 종양 감별,Panorama,경계·피질화·치근 흡수·매복치 관계,영상감별(기본)
임플란트 주위 방사선투과 소견?,Peri-implantitis,크레이터형 결손,https://ex.com/implantitis.jpg,Periapical;임플란트,치주/임플란트 영상,Periaport,합병증 위주 체크,임플란트</pre>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loader" aria-hidden="true"><div class="spinner" aria-label="로딩중"></div></div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ====== 기본 설정 ======
    const baseUrl = 'https://raw.githubusercontent.com/nihicheli/dentblog/main/';
    const ADMIN_KEY='0917';
    const VISIBLE_CATEGORIES_LIMIT = 6;

    // ====== 유틸 ======
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const $  = (sel,root=document)=>root.querySelector(sel);
    const logDev=(...args)=>{ const el = $('#dev-log'); if(!el) return; el.textContent += args.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };
    const note=(msg, warn)=>{ 
        // 5. 모든 알림 메시지 제거
        return;
    };
    const busy=(on,msg)=>{ 
      // 5. 모든 알림 메시지 제거 (로딩 관련 메시지 포함)
      const l=$('#loader'); 
      if(!l) return; 
      if(on){ 
        l.classList.add('show'); 
      } else { 
        l.classList.remove('show'); 
      } 
    };
    const uid=()=>Math.random().toString(36).slice(2,9);
    const slug=s=>(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+uid());
    const esc=s=>(s==null?'':String(s)).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const mdDate=t=>{ const d=new Date(t); const mm=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return `${mm}/${dd}` };
    const norm=s=>(s||'').toString().trim().toLowerCase().replace(/\s+/g,' ');
    const sample=(a,n)=>{const x=[...a]; const out=[]; while(x.length&&out.length<n){ out.push(x.splice((Math.random()*x.length)|0,1)[0]) } return out };
    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[a[i],a[j]]=[a[j]]}return a};
    const parseTags=t=>!t?[]:Array.isArray(t)?t:String(t).split(/;|,/).map(s=>s.trim()).filter(Boolean);
    
    // CSV 파싱 함수 개선 (따옴표 처리, 줄바꿈 인식, 첫 행 헤더 제외)
    const parseGoogleCSV = (txt, type) => {
      if (!txt) return [];
      const lines = txt.split(/\r?\n/);
      const headers = {
        'blogs': ['id', 'title', 'body', 'date', 'category'],
        'sets': ['q', 'a', 'e', 'img', 'tags', 'set', 'modality', 'set_desc', 'group']
      };
      
      let dataLines = [];
      let inQuote = false;
      let currentLine = '';

      lines.forEach(line => {
        let quoteCount = (line.match(/"/g) || []).length;
        
        if (inQuote) {
          currentLine += '\n' + line;
        } else {
          currentLine = line;
        }
        
        if (quoteCount % 2 !== 0) {
          inQuote = !inQuote;
        }

        if (!inQuote && currentLine.trim() !== '') {
          dataLines.push(currentLine);
        }
      });

      if (dataLines.length <= 1) return []; // 첫 번째 줄은 항상 헤더로 간주하고 제외

      const contentLines = dataLines.slice(1);

      const out = [];
      contentLines.forEach(line => {
        const cols = [];
        let cur = '';
        let q = false;
        for(let i=0; i<line.length; i++){
          const ch = line[i];
          if(ch==='"' && line[i+1]==='"' && q){ /* 따옴표 내의 이스케이프된 따옴표 처리 */
            cur += '"';
            i++;
          } else if(ch==='"'){
            q = !q;
          } else if(ch===',' && !q){
            cols.push(cur.trim());
            cur = '';
          } else {
            cur += ch;
          }
        }
        cols.push(cur.trim());

        const row = {};
        headers[type].forEach((h, idx) => {
          row[h] = cols[idx] || '';
        });
        out.push(row);
      });
      
      return out;
    };
    
    const ph=label=>{ const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='720' height='420'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#e5e7eb'/><stop offset='1' stop-color='#cbd5e1'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><g fill='#1f2937' font-family='Arial' text-anchor='middle'><text x='50%' y='50%' font-size='22' font-weight='700'>${esc(label)}</text><text x='50%' y='58%' font-size='12' fill='#6b7280'>Demo Placeholder</text></g></svg>`; return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); };

    // ====== TTS ======
    const tts = { synth: window.speechSynthesis, state: 'idle',
      speak(text){
        try{
          if(!text||!this.synth) return;
          if(this.synth.speaking){ this.synth.cancel(); }
          const u=new SpeechSynthesisUtterance(text);
          u.lang='ko-KR';
          u.onend=()=>{ this.state='idle'; updateTTSLabels(); };
          this.synth.speak(u);
          this.state='speaking';
          updateTTSLabels();
        }catch(e){}
      },
      toggle(text){
        if(this.state==='speaking'){ this.pause(); return; }
        if(this.state==='paused'){ this.resume(); return; }
        this.speak(text);
      },
      pause(){ try{ this.synth.pause(); this.state='paused'; updateTTSLabels(); }catch(e){} },
      resume(){ try{ this.synth.resume(); this.state='speaking'; updateTTSLabels(); }catch(e){} },
      stop(){ try{ this.synth.cancel(); this.state='idle'; updateTTSLabels(); }catch(e){} }
    };
    function updateTTSLabels(){
      $$('.btn.icon[data-action="tts-body"]').forEach(b=>{ b.textContent = (tts.state==='speaking')? '❚❚' : (tts.state==='paused'? '▶' : '▶'); });
      $$('.btn.icon[data-action="tts-stop"]').forEach(b=> b.textContent='■');
    }
    
    // ====== Markdown / 텍스트 변환 ======
    const markdown = (src = '') => {
      let s = marked.parse(src);
      markdown.headings = [];
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = s;
      
      const headings = tempDiv.querySelectorAll('h1, h2, h3, h4');
      headings.forEach((h, i) => {
        const id = slug(h.textContent) + '-' + i;
        h.id = id;
        markdown.headings.push({ id, level: parseInt(h.tagName[1]), text: h.textContent });
      });

      return tempDiv.innerHTML;
    };
    
    const toPlainText = (md='')=>{
      const tmp = document.createElement('div'); tmp.innerHTML = markdown(md||'');
      return (tmp.textContent||'').replace(/\s+\n/g,'\n');
    };

    // ====== 데모 데이터 ======
    let DemoSets = [];
    let BlogPosts = [];
    const SetsFilters = { group: '', modality: '', tags: [] };
    const BlogsFilters = { category: [], sort: 'desc', showAllCategories: false, filtersOpen: true, listOpen: true, tocOpen: false };

    // ====== 테마 ======
    const Theme={
      toggle(){
        document.documentElement.classList.toggle('dark');
        const isDark=document.documentElement.classList.contains('dark');
        $('#theme-btn').textContent=isDark?'🌙':'☀️';
        localStorage.setItem('theme', isDark?'dark':'light');
      },
      init(){
        const saved=localStorage.getItem('theme');
        if(saved==='dark'){ document.documentElement.classList.add('dark'); $('#theme-btn').textContent='🌙'; }
        else { $('#theme-btn').textContent='☀️'; }
      }
    };

    // ====== 라우팅 ======
    function routeTo(view, params={}){
      if(!document.getElementById('view-flash').classList.contains('active') && view==='flash'){}
      else if(document.getElementById('view-flash').classList.contains('active') && view!=='flash'){ Flash.stopAutoplay(); }
      $$('section.view').forEach(s=>s.classList.remove('active'));
      $('#view-'+view)?.classList.add('active');
      $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.nav===view));
      routeTo.params = params;
      if(view==='home')  renderHome();
      if(view==='sets')  renderSetList();
      if(view==='flash') Flash.mount();
      if(view==='quiz')  Quiz.mount();
      if(view==='blog')  Blog.render();
      if(view==='admin') Admin.mount();
      history.replaceState(null, '', '#'+view);
    }
    window.addEventListener('hashchange',()=>{ const v=(location.hash||'#home').slice(1); routeTo(v, routeTo.params||{}); });

    const homeStats=()=>({ sets: DemoSets.length, cards: DemoSets.reduce((n,s)=>n+(s.cards?.length||0),0), blogs: BlogPosts.length });
    function renderHome(){
      const st=homeStats();
      $('#home-stats').innerHTML = [
        `<span class='stat'>세트 <b style="font-weight:700;">${st.sets}</b></span>`,
        `<span class='stat'>카드 <b style="font-weight:700;">${st.cards}</b></span>`,
        `<span class='stat'>칼럼 <b style="font-weight:700;">${st.blogs}</b></span>`
      ].join(' ');
      
      $('#home-reco').innerHTML = DemoSets.map(s=>tile(s)).join('');
      
      const latest = [...BlogPosts].sort((a,b)=>b.when-a.when).slice(0,6)
        .map(p=>`<a class='card' href="#blog" data-action="blog-select" data-id="${p.id}" style='padding:12px;'>
          <div style='font-weight:700; font-size:var(--fs-body);'>${esc(p.title)}</div>
          <div class='muted' style='font-size:var(--fs-xsmall); margin-bottom:6px;'>${mdDate(p.when)}${p.category? ' · '+esc(p.category):''}</div>
          <div class='muted' style='overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; font-size: var(--fs-xsmall); line-height: 1.4;'>
            ${esc(toPlainText(p.body||'').slice(0,180))}...
          </div>
        </a>`).join('');
      $('#home-blog-list').innerHTML = latest || '<div class="muted">글이 없습니다.</div>';
    }
    function tile(s){
      const tags = (s.tags||[]).slice(0,3).map(t=>`<span class='chip'>#${esc(t)}</span>`).join('');
      const count = (s.cards?.length||0);
      const mod = s.modality||'Mixed';
      const img = (s.cards && s.cards[0]?.img) || '';
      const thumb = '' 
    
      return `<div class='set-tile'>
        ${thumb}
        <div class='tile-body'>
          <div style='display:flex;align-items:center;gap:8px;justify-content:space-between'>
            <div style='font-weight:700; font-size:var(--fs-body);'>${esc(s.title)}</div>
            <span class='chip'><span class='card-count' style="font-weight: 700;">🃏 ${count}장</span></span>
          </div>
          <div style='display:flex;gap:8px;margin-top:6px'>
            <button class='btn primary small' data-action='start-mode' data-mode='flash' data-id='${s.id}'>Flash</button>
            <button class='btn small' data-action='start-mode' data-mode='quiz' data-id='${s.id}'>Quiz</button>
          </div>
        </div>
      </div>`;
    }
    function uniqueGroups(){ const set = new Set((DemoSets||[]).map(s=> (s.group||'').trim()).filter(Boolean)); return Array.from(set).sort(); }
    function uniqueModalities(){ const set = new Set((DemoSets||[]).map(s=> (s.modality||'').trim()).filter(Boolean)); return Array.from(set).sort(); }
    function uniqueSetsTags(){ const allTags = DemoSets.flatMap(s => (s.tags || [])).filter(t => t.trim() !== ''); const tagCounts = {}; allTags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1); return Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]); }

    function renderSetFilters(){
        const groups = uniqueGroups();
        const groupSelect = $('#group');
        groupSelect.innerHTML = '<option value="">전체</option>' + groups.map(g => `<option value="${esc(g)}" ${SetsFilters.group === g ? 'selected' : ''}>${esc(g)}</option>`).join('');
        
        const mods = uniqueModalities();
        const modSelect = $('#mod');
        modSelect.innerHTML = '<option value="">전체</option>' + mods.map(m => `<option value="${esc(m)}" ${SetsFilters.modality === m ? 'selected' : ''}>${esc(m)}</option>`).join('');

        const tags = uniqueSetsTags();
        const tagsList = $('#tag-filter-list');
        tagsList.innerHTML = tags.map(t => `<button class="btn small filter ${SetsFilters.tags.includes(t) ? 'active' : ''}" data-action="filter-tag" data-filter-value="${esc(t)}">#${esc(t)}</button>`).join('');
    }

    function renderSetList(){
      renderSetFilters();
      const q = $('#q-header')?.value?.trim().toLowerCase()||''; // 헤더 검색창 사용
      const groupFilter = SetsFilters.group;
      const modFilter = SetsFilters.modality;
      const activeTags = SetsFilters.tags;

      const list = DemoSets.filter(s=>{
        const bag=[s.title,s.desc,s.modality,s.group,(s.tags||[]).join(' '),(s.cards||[]).map(c=>[c.q,c.a,(c.tags||[]).join(' ')].join(' ')).join(' ')].join(' ').toLowerCase();
        const okQ=!q||bag.includes(q);
        const okG=!groupFilter|| norm(s.group)===norm(groupFilter);
        const okM=!modFilter|| norm(s.modality)===norm(modFilter);
        const okT=activeTags.length===0 || activeTags.every(t => (s.tags||[]).includes(t));
        
        return okQ && okG && okM && okT;
      });
      $('#set-list').innerHTML = list.map(s => tile(s)).join('') || '<div class="card muted">조건에 맞는 세트가 없습니다.</div>';
    }

    // ====== Flash ======
    const Flash={ i:0, flipped:false, order:[], bins:[[],[],[],[],[]], setId:null, countdownId:null, autoNext:true, autoNextDelay:5000, autoplay:false,
      mount(){
        if(!CurrentSet) CurrentSet=DemoSets[0];
        $('#flash-title').textContent=CurrentSet?.title||'';
        if(this.setId!==CurrentSet?.id){ this.reset(); }
        const labels=['1회차','2회차','3회차','4회차','5회차'];
        $('#bins').innerHTML = labels.map((lb)=>`
          <div class="bin">
            <div class="bin-bar"><i style="width:0%"></i></div>
            <div class="muted" style="font-size:12px;margin-top:4px">${lb}</div>
            <div style="font-weight:700;font-size:var(--fs-body)">0</div>
          </div>`).join('');
        $('#auto-next').checked = this.autoNext;
        $('#auto-next-delay').value = String(this.autoNextDelay);
        $('#autoplay-btn').textContent = this.autoplay ? '❚❚' : '▶';
        this.render();
        if(!CurrentSet?.cards?.length){ note('이 세트에는 카드가 없습니다. Admin에서 데이터 확인 또는 원격 새로고침을 실행하세요.', true); }
        Flash.updateNavButtons(this.i);
      },
      reset(){ 
        this.setId=CurrentSet?.id||null; 
        this.order = (CurrentSet?.cards||[]).map((_,i)=>i); 
        this.bins=[[],[],[],[],[]]; 
        this.bins[0]=[...this.order]; 
        this.i=0; 
        this.flipped=false; 
        this.stopTimer(); 
        this.render(); 
        Flash.updateNavButtons(this.i);
      },
      card(){ return CurrentSet?.cards?.[this.order[this.i]]; },
      showFront(){ 
          this.flipped=false; 
          const fc=$('#flash-card'); 
          const b=$('#flash-back'); 
          const hint=$('#flash-card .hint');
          fc.classList.remove('show-back'); 
          fc.classList.add('show-front'); 
          if(b) b.style.display='none'; 
          if(hint) hint.style.display='block';
      },
      showBack(){ 
          this.flipped=true; 
          const fc=$('#flash-card'); 
          const b=$('#flash-back'); 
          const hint=$('#flash-card .hint');
          fc.classList.remove('show-front'); 
          fc.classList.add('show-back'); 
          if(b) b.style.display='block'; 
          if(hint) hint.style.display='none'; // 정답 보일 때 힌트 문구 삭제
      },
      toggle(){ 
          // 3. 타이머 기능 복구
          if (this.flipped) {
              this.showFront(); 
          } else {
              this.showBack();
              this.stopTimer(); 
              
              if($('#auto-next').checked) { 
                  const delay = +($('#auto-next-delay').value||this.autoNextDelay);
                  setTimeout(()=> {
                      if(this.autoplay){
                          this.next();
                          if(this.allMastered()) this.stopAutoplay(true); else this.startTimer();
                      } else {
                          this.next();
                      }
                  }, delay || 5000);
              }
          }
      },
      next(){
        const total = this.order.length;
        let attempts = 0;
        do{
          if(this.i<total-1) this.i++; else this.i=0;
          attempts++;
          const idx=this.order[this.i];
          const where=this.binOf(idx);
          if(where < 4) break;
          if(attempts>total) break;
        }while(true);
        this.flipped=false; this.stopTimer(); this.render();
        Flash.updateNavButtons(this.i);
      },
      prev(){ 
        if(this.i>0){ 
            this.i--; 
            this.flipped=false; 
            this.stopTimer(); 
            this.render(); 
        } 
        Flash.updateNavButtons(this.i);
      },
      updateNavButtons(currentIndex){
          const total = this.order.length;
          const prevBtn = $('#flash-prev-btn');
          const nextBtn = $('#flash-next-btn');
          
          const title = CurrentSet?.title || '세트';
          
          if(currentIndex > 0){
              prevBtn.textContent = `← ${title}`;
              prevBtn.style.visibility = 'visible';
          } else {
              prevBtn.textContent = `← 이전 카드`;
              prevBtn.style.visibility = 'hidden';
          }
          
          if(currentIndex < total - 1){
              nextBtn.textContent = `${title} →`;
              nextBtn.style.visibility = 'visible';
          } else {
              nextBtn.textContent = `다음 카드 →`;
              nextBtn.style.visibility = 'hidden';
          }
      },
      binOf(idx){ return this.bins.findIndex(b=>b.includes(idx)); },
      moveBin(idx, to){ let from=this.binOf(idx); if(from<0) from=0; this.bins[from]=this.bins[from].filter(x=>x!==idx); this.bins[to].push(idx); },
      grade(ok){
        if(!CurrentSet) return;
        const idx=this.order[this.i];
        let from=this.binOf(idx); if(from<0) from=0;
        const to= ok? Math.min(from+1,4):0;
        this.moveBin(idx, to);
        note(ok? '✓ 알았다':'× 몰랐다');
        this.next(); this.renderBins();
        if(this.autoplay && this.allMastered()) this.stopAutoplay(true);
      },
      startTimer(){
        this.stopTimer(); this.showFront();
        let t = +$('#timer-select').value;
        const cd=$('#countdown'); cd.textContent=t; cd.classList.add('show');
        this.countdownId = setInterval(()=>{
          t--; cd.textContent=t;
          if(t<=0){
            clearInterval(this.countdownId); this.countdownId=null;
            cd.classList.remove('show');
            this.showBack(); note('정답 공개!');
            if($('#auto-next').checked){
              const delay = +($('#auto-next-delay').value||this.autoNextDelay);
              setTimeout(()=> {
                if(this.autoplay){
                  this.next();
                  if(this.allMastered()) this.stopAutoplay(true); else this.startTimer();
                } else {
                  this.next();
                }
              }, delay || 5000);
            }
          }
        },1000);
      },
      stopTimer(){ const cd=$('#countdown'); if(cd){ cd.textContent=''; cd.classList.remove('show'); } if(this.countdownId){ clearInterval(this.countdownId); this.countdownId=null; } },
      render(){
        this.stopTimer();
        if(!CurrentSet?.cards?.length){
          $('#flash-img').src=''; $('#flash-answer').textContent=''; $('#flash-explain').textContent='카드가 없습니다.'; $('#flash-pos').textContent='0/0'; $('#flash-bar').style.width='0%';
          $('#flash-card').classList.add('show-front'); return;
        }
        const k=this.card(); if(!k) return;
        $('#flash-img').src=k.img||ph('No image');
        $('#flash-question').textContent = k.q || '이 영상의 진단명은?';
        $('#flash-answer').innerHTML=`<span>${esc(k.a||'')}</span>`;
        $('#flash-explain').innerHTML=`<span>${esc(k.e||'')}</span>`;
        $('#flash-pos').textContent=`${this.i+1}/${this.order.length}`;
        $('#flash-bar').style.width=((this.i+1)/this.order.length*100|0)+'%';
        this.renderBins();
        this.showFront();
      },
      renderBins(){ const binEls = $$('#bins .bin'); const total = CurrentSet?.cards?.length||0; this.bins.forEach((b,i)=>{ const el=binEls[i]; if(!el||!total) return; el.querySelector('.bin-bar i').style.width = `${(b.length/total)*100}%`; el.querySelector('div:last-child').textContent = b.length; }); },
      toggleAutoplay(){
        this.autoplay = !this.autoplay;
        $('#autoplay-btn').textContent = this.autoplay ? '❚❚' : '▶︎';
        if(this.autoplay){
          $('#auto-next').checked = true;
          const firstUnsolved = this.order.findIndex(idx => this.binOf(idx) < 4);
          if(firstUnsolved>=0) this.i = firstUnsolved;
          this.startTimer();
        }else{ this.stopTimer(); }
      },
      stopAutoplay(done=false){ this.autoplay=false; $('#autoplay-btn').textContent = '▶'; this.stopTimer(); if(done) note('모든 카드 5회차 완료! 자동 진행 종료'); },
      allMastered(){ return this.order.every(idx => this.binOf(idx)===4); }
    };

    // ====== Quiz ======
    let CurrentSet = null;
    const Quiz={ sheet:[], i:0, score:0,
      mount(){ 
        if(!CurrentSet) CurrentSet=DemoSets[0]; 
        $('#quiz-title').textContent=(CurrentSet?.title||'')+' – Quiz'; 
        $('#quiz-stage').style.display='none'; 
        this.updateNavButtons();
      },
      start(){
        if(!CurrentSet?.cards?.length){ note('이 세트에 카드가 없어 퀴즈를 시작할 수 없습니다.', true); return; }
        const mode=$('#quiz-mode').value; const n=+$('#quiz-n').value;
        const pool=[...(CurrentSet?.cards||[])];
        this.sheet = sample(pool, Math.min(n,pool.length)).map(c=> makeQ(mode,c));
        this.i=0; this.score=0; this.render();
      },
      cur(){ return this.sheet[this.i]; },
      render(){
        const q=this.cur(); const stage=$('#quiz-stage'); stage.style.display='block';
        stage.innerHTML = `
        <div class='muted' style='display:flex;gap:8px;align-items:center;margin-bottom:8px'>
          문항 <b style="font-weight:700;">${this.i+1}/${this.sheet.length}</b>
          <span style='margin-left:auto'>점수 <b style="font-weight:700;">${this.score}</b></span>
        </div>
        <div style='display:grid;gap:10px'>
          ${q?.image?`<img src='${q.image}' alt='x-ray' style="max-height:360px; object-fit:contain"/>`:''}
          <div style='font-weight:700; font-size:var(--fs-h2)'>
            <span>${esc(q?.stem||'')}</span>
          </div>
          <div id='quiz-opts' class='grid' style="gap:8px"></div>
          <div id='quiz-exp' class='muted' style='display:none'></div>
          <div style='display:flex;gap:8px'>
            <button class='btn' data-action='quiz-prev'>이전</button>
            <button class='btn primary' data-action='quiz-next'>다음</button>
          </div>
        </div>`;
        const wrap=$('#quiz-opts');
        if(!q) return;
        if(q.kind==='mc'||q.kind==='tf'){
          q.options.forEach((opt,idx)=>{ const el=document.createElement('div'); el.className='opt'; el.textContent=opt; el.dataset.action='quiz-pick'; el.dataset.idx=idx; wrap.appendChild(el); });
        } else {
          const input=document.createElement('input'); input.placeholder='정답 입력'; input.style.cssText='padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a';
          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='확인'; btn.dataset.action='quiz-fill';
          wrap.appendChild(input); wrap.appendChild(btn);
        }
        this.updateNavButtons();
      },
      updateNavButtons(){
          const prevBtn = $('#quiz-nav-buttons [data-action="quiz-prev"]');
          const nextBtn = $('#quiz-nav-buttons [data-action="quiz-next"]');
          if (prevBtn) prevBtn.style.visibility = (this.i > 0 && this.sheet.length > 0) ? 'visible' : 'hidden';
          if (nextBtn) nextBtn.style.visibility = (this.i < this.sheet.length - 1 && this.sheet.length > 0) ? 'visible' : 'hidden';
      },
      pick(idx){ const q=this.cur(); const nodes=$$('#quiz-opts .opt'); nodes.forEach((n,i)=>{n.dataset.action=''; n.classList.toggle('correct', i===q.answerIndex); if(i===idx && i!==q.answerIndex) n.classList.add('wrong');}); if(idx===q.answerIndex){this.score++; note('정답!');} else {note('오답');} this.explain(); },
      fillCheck(val){ const q=this.cur(); const ok = norm(val)===norm(q.answerText); if(ok){this.score++; note('정답!');} else {note('오답');} this.explain(ok?undefined:`정답: ${q.answerText}`); },
      explain(extra){ const q=this.cur(); const exp=$('#quiz-exp'); exp.style.display='block'; exp.textContent = (extra? extra+ ' · ' : '') + (q.explain||''); },
      next(){ if(this.i<this.sheet.length-1){ this.i++; this.render(); } else this.finish(); },
      prev(){ if(this.i>0){ this.i--; this.render(); } },
      finish(){ 
        const acc=((this.score/this.sheet.length)*100|0); 
        $('#quiz-stage').innerHTML = `<div style='font-size:var(--fs-h2); font-weight:700; margin-bottom:6px'>퀴즈 완료!</div><div class='muted'>최종 점수</div><div class='quiz-result-score'>${this.score}/${this.sheet.length} (${acc}%)</div><div style='display:flex;gap:8px'><button class='btn primary' data-action='quiz-restart'>다시 풀기</button><button class='btn' data-action='start-mode' data-mode='flash'>Flash 복습</button></div>`; 
      }
    };
    function makeQ(mode, k){
      if(mode==='tf'){ const truth = Math.random()<0.5; const others = DemoSets.flatMap(s=>s.cards).filter(x=>x!==k); const alt = others.length? sample(others,1)[0] : k; const text = truth ? k.a : alt.a; const stem = '이 영상의 진단명은 ' + esc(text) + ' 이다.'; return {kind:'tf', stem, image:k.img, explain:k.e, options:['O','X'], answerIndex: truth?0:1}; }
      if(mode==='fill'){ return {kind:'fill', stem:'아래 영상의 진단명을 입력하세요.', image:k.img, explain:k.e, answerText:k.a}; }
      const others = DemoSets.flatMap(s=>s.cards).filter(x=>x!==k); const picks = sample(others, Math.min(3, others.length)).map(o=>o.a); const opts = [...picks, k.a]; shuffle(opts); return {kind:'mc', stem:'아래 영상의 진단명은?', image:k.img, explain:k.e, options:opts, answerIndex:opts.indexOf(k.a)};
    }

    // ====== Blog ======
    const Blog={ curId:null, blogList:[],
      new(){ /* 관리자 기능 제거 */ },
      select(id){ 
        this.curId=id; 
        const p=BlogPosts.find(x=>x.id===id); 
        if(!p) return; 
        this.renderView(p); 
        $$('#blog-list a').forEach(el => el.classList.toggle('active', el.dataset.id === id));
        this.updateNavButtons(id);
        $('#blog-view').scrollIntoView({ behavior: 'smooth', block: 'start' });
      },
      renderView(p){
        const htmlBody = markdown(p.body || ''); 
        const html = `<h1>${esc(p.title)}</h1><div class="muted" style="margin-bottom:12px">${mdDate(p.when)}${p.category? ' · '+esc(p.category):''}</div>`+ htmlBody; 
        $('#blog-view').innerHTML=html;
        Blog.renderTOC();
      },
      updateNavButtons(currentId){
        const list = this.blogList;
        const currentIndex = list.findIndex(p => p.id === currentId);
        const prevPost = list[currentIndex - 1];
        const nextPost = list[currentIndex + 1];

        const prevBtn = $('#blog-prev-btn');
        const nextBtn = $('#blog-next-btn');

        if (prevPost) {
            prevBtn.style.visibility = 'visible';
            prevBtn.dataset.id = prevPost.id;
            prevBtn.textContent = `← ${esc(prevPost.title)}`;
        } else {
            prevBtn.style.visibility = 'hidden';
            prevBtn.textContent = '← 이전 글';
        }

        if (nextPost) {
            nextBtn.style.visibility = 'visible';
            nextBtn.dataset.id = nextPost.id;
            nextBtn.textContent = `${esc(nextPost.title)} →`;
        } else {
            nextBtn.style.visibility = 'hidden';
            nextBtn.textContent = '다음 글 →';
        }
      },
      prev(){
        const list = this.blogList;
        const currentIndex = list.findIndex(p => p.id === this.curId);
        if (currentIndex > 0) {
            this.select(list[currentIndex - 1].id);
        }
      },
      next(){
        const list = this.blogList;
        const currentIndex = list.findIndex(p => p.id === this.curId);
        if (currentIndex < list.length - 1) {
            this.select(list[currentIndex + 1].id);
        }
      },
      renderTOC(){
        const toc = markdown.headings || [];
        const el=$('#blog-toc');
        const tocWrapper = $('#blog-toc-wrapper');
        
        if(!toc.length){
            el.style.display='none';
            tocWrapper.style.display='none';
            el.innerHTML='';
            return;
        }

        tocWrapper.style.display='block';
        
        let h='<div style="font-weight:700;margin:10px 0 6px">목차</div><ul>';
        let prev = 1;
        toc.forEach(({id, level, text})=>{
            if(level>prev) h+='<ul>';
            else if(level<prev) h+='</ul>'.repeat(prev-level);
            h+=`<li><a href="javascript:void(0)" data-action="toc-goto" data-target="${id}">${esc(text)}</a></li>`;
            prev=level;
        });
        h+='</ul>'.repeat(prev)+'</ul>';
        el.innerHTML=h;

        if (BlogsFilters.tocOpen) {
            el.style.display = 'block';
            $('#blog-toc-toggle-btn').textContent = '⏶';
        } else {
            el.style.display = 'none';
            $('#blog-toc-toggle-btn').textContent = '⏷';
        }
      },
      render(){
        const q = ($('#blog-q')?.value||'').toLowerCase();
        const sort = BlogsFilters.sort;
        const categories = BlogsFilters.category;

        let list = [...BlogPosts].filter(p=>!q|| p.title.toLowerCase().includes(q)||p.body.toLowerCase().includes(q));
        
        if (categories.length > 0) {
            list = list.filter(p => {
                const postCategories = (p.category || '').split(/;|,/).map(c => c.trim()).filter(c => c !== '');
                return categories.every(c => postCategories.includes(c));
            });
        }

        list.sort((a,b) => {
            if (sort === 'desc') return b.when - a.when;
            else return a.when - b.when;
        });

        this.blogList = list;

        $('#blog-list').innerHTML = list.map(p=>`<li><a data-action='blog-select' data-id='${p.id}'>${esc(p.title)}</a></li>`).join('') || '<div class="muted" style="padding:8px">글이 없습니다.</div>';
        
        // 목록 표시 상태 업데이트
        if (BlogsFilters.listOpen) {
            $('#blog-list-toggle-btn').textContent = '⏶';
            $('#blog-list-wrapper').style.display = 'block';
        } else {
            $('#blog-list-toggle-btn').textContent = '⏷';
            $('#blog-list-wrapper').style.display = 'none';
        }

        if(this.curId){ 
            const p = list.find(x=>x.id===this.curId);
            if(p) this.select(this.curId);
            else if (list.length > 0) this.select(list[0].id);
        } else if (list.length > 0) { 
            this.select(list[0].id);
        } else { 
            $('#blog-view').innerHTML = ''; 
            $('#blog-toc').style.display = 'none'; 
            this.updateNavButtons(null);
        }
        renderHome();
        this.renderFilters();
      },
      speakBody(){ const p=BlogPosts.find(x=>x.id===this.curId); if(!p) return; const text = toPlainText(p.body||''); if(!text.trim()) { note('읽을 본문이 없습니다.'); return; } tts.toggle(text); },
      stopSpeak(){ tts.stop(); },
      
      updateFilterVisibility(){
        const filters = $('#blog-filters');
        const btn = $('#blog-filters-toggle-btn');
        if (filters) filters.style.display = BlogsFilters.filtersOpen ? 'block' : 'none';
        if (btn) btn.textContent = BlogsFilters.filtersOpen ? '⏶' : '⏷';
      },
      toggleList(){
        BlogsFilters.listOpen = !BlogsFilters.listOpen;
        this.render();
      },
      toggleFilters(){
        BlogsFilters.filtersOpen = !BlogsFilters.filtersOpen;
        this.updateFilterVisibility();
      },
      toggleToc(){
        BlogsFilters.tocOpen = !BlogsFilters.tocOpen;
        const el = $('#blog-toc');
        const btn = $('#blog-toc-toggle-btn');
        if (el) el.style.display = BlogsFilters.tocOpen ? 'block' : 'none';
        if (btn) btn.textContent = BlogsFilters.tocOpen ? '⏶' : '⏷';
      },
      
      renderFilters(){
          const allCategories = [...new Set(BlogPosts.flatMap(p => (p.category || '').split(/;|,/).map(c => c.trim()).filter(c => c !== '')))];
          const filterList = $('#category-filter-list');
          let displayCategories = allCategories;
          let toggleButton = '';
          
          if (allCategories.length > VISIBLE_CATEGORIES_LIMIT) {
              if (!BlogsFilters.showAllCategories) {
                  displayCategories = allCategories.slice(0, VISIBLE_CATEGORIES_LIMIT);
                  toggleButton = `<button class="btn small" data-action="toggle-categories">전체</button>`;
              } else {
                  toggleButton = `<button class="btn small" data-action="toggle-categories">접기</button>`;
              }
          }

          filterList.innerHTML = displayCategories.map(c => `<button class="btn small filter ${BlogsFilters.category.includes(c) ? 'active' : ''}" data-action="filter-category" data-filter-value="${esc(c)}">${esc(c)}</button>`).join('') + toggleButton;

          $('#blog-sort').value = BlogsFilters.sort;
          this.updateFilterVisibility();
      }
    };

    // ====== Admin (기능은 유지하되 UI에서 숨김) ======
    const Admin={ mount(){ fillTargetSets(); $('#adm-key').value=''; },
      checkKey(){ const k=$('#adm-key').value.trim(); if(k!==ADMIN_KEY){ note('관리자 키 오류',true); return false } return true; },
      uploadJSON(){ if(!this.checkKey())return; try{ const arr=JSON.parse($('#adm-json').value||'[]'); addCards(arr, targetSetId()); note('등록 완료'); routeTo('sets'); }catch(e){ note('JSON 오류: '+e.message,true) } },
      uploadFile: async ()=>{ if(!Admin.checkKey()) return;
        const f=$('#adm-file').files?.[0]; if(!f){ note('파일 선택'); return; }
        const ext = (f.name.split('.').pop()||'').toLowerCase();
        const buf = await f.arrayBuffer();
        let rows=[];
        try{
          if(ext==='csv'){ const text = new TextDecoder('utf-8').decode(buf); rows = parseCSV(text);
          } else if(ext==='xlsx'){ await ensureXLSX(); const wb = XLSX.read(buf, {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; rows = XLSX.utils.sheet_to_json(ws, {defval:''});
          } else if(ext==='json'){ rows = JSON.parse(new TextDecoder('utf-8').decode(buf));
          } else { note('지원하지 않는 형식', true); return; }
        }catch(e){ note('파싱 실패: '+e.message, true); return; }
        if(Array.isArray(rows) && rows.length && !rows[0].q && rows[0].cards){ replaceSets(rows);
        }else{ addCards(rows, targetSetId()); }
        note('등록 완료'); routeTo('sets');
      },
      exportAll(){ const data = { sets: DemoSets, blogs: BlogPosts }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dentblog-backup.json'; a.click(); },
      resetConfirm(){ if(!this.checkKey())return; if(!confirm('정말 모든 데이터를 초기화할까요?')) return; localStorage.clear(); location.reload(); }
    };
    function targetSetId(){ const sel=$('#adm-target').value; const name=($('#adm-newset').value||'').trim(); if(sel==='__new__' && name){ let s={id:slug(name), modality:'Mixed', title:name, desc:'관리자 생성 세트', tags:['custom'], cards:[]}; DemoSets.push(s); fillTargetSets(); return s.id; } return sel; }
    function fillTargetSets(){ const el=$('#adm-target'); if(!el) return; const opts = (DemoSets||[]).map(s=>`<option value='${s.id}'>${esc(s.title)} (${s.cards?.length||0})</option>`).join('') + `<option value='__new__'>+ 새 세트…</option>`; el.innerHTML=opts; }
    function addCards(arr,setId){
      const s = DemoSets.find(x=>x.id===setId)||DemoSets[0]; if(!s) return;
      (arr||[]).forEach(row=>{
        const q = row.q || row.question || '';
        const a = row.a || row.answer || '';
        const e = row.e || row.explain || row.explanation || '';
        const img = row.img || '';
        const tags = parseTags(row.tags);
        const modality = row.modality || s.modality || 'Mixed';
        const setDesc = row.set_desc || s.desc || '';
        const group = row.group || s.group || '';
        s.modality = modality; s.desc = setDesc; s.group = group;
        s.cards.push({ q, a, e, img: img||ph(a||'Card'), tags });
      });
      persist(); renderSetList(); renderHome();
    }
    function replaceSets(newSets){
      if(!Array.isArray(newSets)) return;
      newSets.forEach(s=>{
        s.id = s.id || slug(s.title||'set');
        s.cards = (s.cards||[]).map(c=>({ ...c, img: c.img || ph(c.a||'Card') }));
      });
      DemoSets.length = 0;
      newSets.forEach(s=> DemoSets.push(s));
      fillTargetSets(); persist(); renderSetList(); renderHome();
      note('세트가 원격 데이터로 갱신되었습니다.');
    }

    // ====== 상태 저장 ======
    const KEY='dentblog_state_v1';
    const persist=()=>{ try{ localStorage.setItem(KEY, JSON.stringify({sets:DemoSets, blogs:BlogPosts})); }catch(e){ } };
    function restoreLocal(){
      const raw=localStorage.getItem(KEY);
      if(!raw) return false;
      try{
        const st=JSON.parse(raw);
        if(st.sets) replaceSets(st.sets);
        if(st.blogs) BlogPosts=st.blogs;
        return true;
      }catch(e){ return false; }
    }

    // ====== 원격 로드 ======
    const fetchText = async (url)=> (await fetch(url, {cache:'no-store'})).text();
    const fetchJSON = async (url)=> (await fetch(url, {cache:'no-store'})).json();
    const fetchBuf  = async (url)=> (await fetch(url, {cache:'no-store'})).arrayBuffer();
    
    async function tryLoadSetsFromGoogleSheet(){
      try{
        const sheetId = "1BWSJMBLuEU2v7eon5MdM02fAFHV0z5T2tr3_42K15dY";
        const gid = "66467758";
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
    
        const txt = await fetchText(url);
        const rows = parseGoogleCSV(txt, 'sets');
        if(rows.length){
          const bySet = {};
          rows.forEach(r=>{
            const setName = (r.set || '기본 세트').trim();
            if(!bySet[setName]){
              bySet[setName] = { 
                id:slug(setName), 
                modality:r.modality||'Mixed', 
                title:r.set || r.set_desc || setName, 
                desc:r.set_desc||'', 
                group:r.group||'', 
                tags:[], 
                cards:[] 
              };
            }
            if(r.q || r.a){
              bySet[setName].cards.push({ 
                q:r.q||'', 
                a:r.a||'', 
                e:r.e||'', 
                img:r.img||'', 
                tags:parseTags(r.tags) 
              });
            }
          });
          replaceSets(Object.values(bySet));
          logDev('sets <- google sheet', `(${rows.length} rows)`);
          return 'sets.google';
        }
      }catch(e){
        logDev('sets load fail (google):', e.message||e);
      }
      return null;
    }
    
    async function tryLoadBlogsFromGoogleSheet(){
      try{
        const sheetId = "1B9zr1SQ7ROzIgwC2k8TmuTh0KfNM2-Y_FgNclQVEFZA";
        const gid = "908527068";
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
        
        const txt = await fetchText(url);
        const rows = parseGoogleCSV(txt, 'blogs');
        if(rows.length){
          BlogPosts = rows.map(r=>({
            id: r.id || uid(),
            title: r.title || '',
            body: r.body || '',
            when: r.date ? +new Date(r.date) : Date.now(),
            category: r.category || ''
          }));
          persist(); renderHome();
          logDev('blogs <- google sheet', `(${rows.length} rows)`);
          return 'blogs.google';
        }
      }catch(e){
        logDev('blogs load fail (google):', e.message||e);
      }
      return null;
    }
    
    async function remoteReload(){
      busy(true); // 로딩 메시지 없이 로더만 띄움
      const a = await tryLoadSetsFromGoogleSheet();
      const b = await tryLoadBlogsFromGoogleSheet();
      busy(false, (a||b)? '원격 데이터 적용 완료' : '원격 데이터 없음');
    }

    // ====== 이벤트 위임 ======
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-action],[data-nav]');
      if(!el) return;
      const nav = el.dataset.nav;
      if(nav){ routeTo(nav); return; }

      const act = el.dataset.action;

      // 공통
      if(act==='toggle-theme'){ Theme.toggle(); return; }

      // 세트/모드
      if(act==='start-mode'){
        const id = el.dataset.id;
        CurrentSet = DemoSets.find(s=>s.id===id) || DemoSets[0];
        if(el.dataset.mode==='flash') routeTo('flash');
        else routeTo('quiz');
        return;
      }
      if(act==='filter-tag'){
          const tag = el.dataset.filterValue;
          const index = SetsFilters.tags.indexOf(tag);
          if (index > -1) {
              SetsFilters.tags.splice(index, 1);
          } else {
              SetsFilters.tags.push(tag);
          }
          el.classList.toggle('active');
          renderSetList();
          return;
      }

      // Flash
      if(act==='flash-next'){ Flash.next(); return; }
      if(act==='flash-prev'){ Flash.prev(); return; }
      if(act==='flash-toggle'){ Flash.toggle(); return; }
      if(act==='flash-grade'){ Flash.grade( el.dataset.ok==='1' ); return; }
      if(act==='start-timer'){ Flash.startTimer(); return; }
      if(act==='flash-autoplay'){ Flash.toggleAutoplay(); return; }

      // Quiz
      if(act==='quiz-start'){ Quiz.start(); return; }
      if(act==='quiz-next'){ Quiz.next(); return; }
      if(act==='quiz-prev'){ Quiz.prev(); return; }
      if(act==='quiz-restart'){ Quiz.start(); return; }
      if(act==='quiz-pick'){ const idx = +el.dataset.idx; Quiz.pick(idx); return; }
      if(act==='quiz-fill'){ const val = $('#quiz-opts input')?.value||''; Quiz.fillCheck(val); return; }
      if(act==='tts-toggle'){ const t = el.dataset.text||''; tts.toggle(t); return; }
      if(act==='tts-stop'){ tts.stop(); return; }

      // Blog
      if(act==='blog-new'){ Blog.new(); return; }
      if(act==='blog-select'){ const id=el.dataset.id; Blog.select(id); return; }
      if(act==='blog-prev'){ Blog.prev(); return; }
      if(act==='blog-next'){ Blog.next(); return; }
      if(act==='blog-edit'){ Blog.editStart(); return; }
      if(act==='blog-save'){ Blog.save(); return; }
      if(act==='blog-cancel'){ Blog.cancel(); return; }
      if(act==='blog-delete'){ Blog.delete(); return; }
      if(act==='blog-list-toggle'){ Blog.toggleList(); return; }
      if(act==='blog-filters-toggle'){ 
        Blog.toggleFilters(); 
        return; 
      }
      if(act==='blog-toc-toggle'){ 
        Blog.toggleToc();
        return; 
      }
      if(act==='toggle-categories'){
          BlogsFilters.showAllCategories = !BlogsFilters.showAllCategories;
          Blog.renderFilters();
          return;
      }
      if(act==='toc-goto'){ 
        const id=el.dataset.target; 
        const t=document.getElementById(id); 
        if(t) t.scrollIntoView({behavior:'smooth', block:'start'}); 
        return; 
      }
      if(act==='tts-body'){ Blog.speakBody(); return; }
      if(act==='filter-category'){
          const category = el.dataset.filterValue;
          const index = BlogsFilters.category.indexOf(category);
          if (index > -1) {
              BlogsFilters.category.splice(index, 1);
          } else {
              BlogsFilters.category.push(category);
          }
          el.classList.toggle('active');
          Blog.render();
          return;
      }


      // Admin
      if(act==='adm-json'){ Admin.uploadJSON(); return; }
      if(act==='adm-file'){ Admin.uploadFile(); return; }
      if(act==='adm-reset'){ Admin.resetConfirm(); return; }
      if(act==='remote-reload'){ remoteReload(); return; }
    });

    // 입력 이벤트
    $('#q-header')?.addEventListener('input', renderSetList); // 세트 검색창
    $('#group')?.addEventListener('change', (e) => {
      SetsFilters.group = e.target.value;
      renderSetList();
    });
    $('#mod')?.addEventListener('change', (e) => {
      SetsFilters.modality = e.target.value;
      renderSetList();
    });
    $('#blog-q')?.addEventListener('input', ()=> Blog.render());
    $('#blog-sort')?.addEventListener('change', (e) => {
        BlogsFilters.sort = e.target.value;
        Blog.render();
    });

    // 키보드 단축키 (Flash)
    window.addEventListener('keydown',(e)=>{
      const isFlash = $('#view-flash')?.classList.contains('active');
      if(!isFlash) return;
      if(e.code==='Space'){ e.preventDefault(); Flash.toggle(); }
      if(e.key==='ArrowRight'){ Flash.next(); }
      if(e.key==='ArrowLeft'){ Flash.prev(); }
    });
    
    // 키보드 단축키 (Quiz)
    window.addEventListener('keydown',(e)=>{
        const isQuiz = $('#view-quiz')?.classList.contains('active');
        if(!isQuiz || Quiz.sheet.length === 0 || $('#quiz-stage').style.display === 'none') return;

        // Spacebar to pick option 1 (O/X first option)
        if (e.code === 'Space') {
            const currentQuestion = Quiz.cur();
            if (currentQuestion.kind === 'tf' || currentQuestion.kind === 'mc') {
                e.preventDefault();
                const option1 = $('#quiz-opts .opt[data-idx="0"]');
                if (option1) Quiz.pick(0);
            }
        }
        
        // ArrowRight to next question
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            Quiz.next();
        }
        // ArrowLeft to previous question
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            Quiz.prev();
        }
    });


    // ====== 부트스트랩 ======
    (async function init(){
      Theme.init();
      restoreLocal();
      await remoteReload();
      routeTo((location.hash||'#home').slice(1)||'home');
      updateTTSLabels();
    })();
  </script>
</body>
</html>
